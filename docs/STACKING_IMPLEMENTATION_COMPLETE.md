# âœ… Stackingæ¨¡å‹é›†æˆå®æ–½å®Œæˆ

**é¡¹ç›®**: QuantAI-ETH  
**ä¼˜åŒ–é˜¶æ®µ**: Phase 2.3 - ä¸‰æ¨¡å‹Stackingèåˆ  
**å®æ–½æ—¶é—´**: 2025-10-17  
**çŠ¶æ€**: âœ… ä»£ç å®Œæˆï¼Œå¾…å®‰è£…ä¾èµ–å’Œè®­ç»ƒ

---

## ğŸ¯ å®æ–½æ‘˜è¦

### æ–¹æ¡ˆ

**Stackingä¸‰æ¨¡å‹èåˆ**ï¼š
- LightGBMï¼ˆä¸»åŠ›ï¼Œå‡†ç¡®ç‡45.79%ï¼‰
- XGBoostï¼ˆè¾…åŠ©ï¼Œé¢„ä¼°43-45%ï¼‰
- CatBoostï¼ˆè¾…åŠ©ï¼Œé¢„ä¼°43-45%ï¼‰
- LogisticRegressionå…ƒå­¦ä¹ å™¨ï¼ˆå­¦ä¹ ç»„åˆï¼‰

### ç›®æ ‡

**å‡†ç¡®ç‡æå‡**ï¼š
- å½“å‰ï¼š42.81%
- ç›®æ ‡ï¼š48-51%
- æå‡ï¼š+12-19%
- **vs 50%ç›®æ ‡**ï¼šæ¥è¿‘æˆ–è¾¾åˆ° âœ…

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒä»£ç å®ç°

**æ–‡ä»¶**: `backend/app/services/ensemble_ml_service.py`ï¼ˆ545è¡Œï¼‰

**å®ç°åŠŸèƒ½**ï¼š
- âœ… Stackingæ¶æ„è®¾è®¡
- âœ… ä¸‰æ¨¡å‹è®­ç»ƒï¼ˆLightGBM + XGBoost + CatBoostï¼‰
- âœ… å…ƒå­¦ä¹ å™¨è®­ç»ƒï¼ˆLogisticRegressionï¼‰
- âœ… é›†æˆé¢„æµ‹
- âœ… æ¨¡å‹ä¿å­˜/åŠ è½½
- âœ… é™çº§æ–¹æ¡ˆï¼ˆç®€å•åŠ æƒï¼‰
- âœ… å®Œæ•´é”™è¯¯å¤„ç†
- âœ… è¯¦ç»†æ—¥å¿—è®°å½•

**ç‰¹ç‚¹**ï¼š
- ç»§æ‰¿è‡ªMLServiceï¼ˆå¤ç”¨æ‰€æœ‰ç°æœ‰åŠŸèƒ½ï¼‰
- è¦†ç›–train_modelå’Œpredictæ–¹æ³•
- æ— ç¼é›†æˆåˆ°ç°æœ‰ç³»ç»Ÿ

---

### 2. ç³»ç»Ÿé›†æˆ

**ä¿®æ”¹æ–‡ä»¶**: `backend/main.py`

**ä¿®æ”¹å†…å®¹**ï¼š
```python
# å¯¼å…¥é›†æˆæœåŠ¡
from app.services.ensemble_ml_service import ensemble_ml_service

# ä½¿ç”¨é›†æˆæœåŠ¡
ml_service = ensemble_ml_service
```

**å½±å“**ï¼š
- æ‰€æœ‰ä¾èµ–ml_serviceçš„æ¨¡å—è‡ªåŠ¨ä½¿ç”¨Stacking
- signal_generatorè‡ªåŠ¨ä½¿ç”¨é›†æˆé¢„æµ‹
- schedulerè‡ªåŠ¨ä½¿ç”¨é›†æˆè®­ç»ƒ
- æ— éœ€ä¿®æ”¹å…¶ä»–ä»£ç 

---

### 3. ä¾èµ–ç®¡ç†

**æ–‡ä»¶**: `backend/requirements.txt`

**æ–°å¢ä¾èµ–**ï¼š
```
xgboost==2.0.3    # XGBoostæ¨¡å‹
catboost==1.2.2   # CatBoostæ¨¡å‹
```

**ç°æœ‰ä¾èµ–**ï¼š
```
lightgbm==4.1.0   # LightGBMæ¨¡å‹
scikit-learn==1.3.2  # å…ƒå­¦ä¹ å™¨
numpy, pandas, ta, fastapi, ...
```

---

### 4. æ–‡æ¡£å®Œå–„

**åˆ›å»ºæ–‡æ¡£**ï¼š
1. âœ… `STACKING_ENSEMBLE_GUIDE.md` - å®Œæ•´å®æ–½æŒ‡å—
2. âœ… `QUICK_START_STACKING.md` - å¿«é€Ÿå¯åŠ¨æŒ‡å—
3. âœ… `docs/STACKING_IMPLEMENTATION_COMPLETE.md` - æœ¬æ–‡æ¡£

**æ›´æ–°æ–‡æ¡£**ï¼š
4. âœ… `docs/PHASE2_IMPLEMENTATION_GUIDE.md` - Phase 2æŒ‡å—
5. âœ… `.cursor/rules/general.mdc` - æ·»åŠ ä¸“ä¸šè§„èŒƒ

---

## ğŸ—ï¸ Stackingæ¶æ„è¯¦è§£

### ä¸‰å±‚ç»“æ„

```
Layer 0: åŸå§‹ç‰¹å¾ï¼ˆ186ä¸ªï¼‰
    â†“
Layer 1: åŸºç¡€æ¨¡å‹ï¼ˆ3ä¸ªå¹¶è¡Œï¼‰
    â”œâ”€ LightGBM â†’ [p_SHORT, p_HOLD, p_LONG]
    â”œâ”€ XGBoost  â†’ [p_SHORT, p_HOLD, p_LONG]
    â””â”€ CatBoost â†’ [p_SHORT, p_HOLD, p_LONG]
    â†“
Layer 2: å…ƒç‰¹å¾ï¼ˆ9ç»´ï¼‰
    [LGBæ¦‚ç‡Ã—3, XGBæ¦‚ç‡Ã—3, CATæ¦‚ç‡Ã—3]
    â†“
Layer 3: å…ƒå­¦ä¹ å™¨ï¼ˆLogisticRegressionï¼‰
    å­¦ä¹ æœ€ä¼˜ç»„åˆç­–ç•¥
    â†“
Output: æœ€ç»ˆé¢„æµ‹ + ç½®ä¿¡åº¦
```

---

### è®­ç»ƒæµç¨‹

```python
# Stage 1: è®­ç»ƒåŸºç¡€æ¨¡å‹
lgb_model = train_lightgbm(X_train, y_train)
xgb_model = train_xgboost(X_train, y_train)
cat_model = train_catboost(X_train, y_train)

# Stage 2: ç”Ÿæˆå…ƒç‰¹å¾ï¼ˆè®­ç»ƒé›†ï¼‰
meta_train = np.hstack([
    lgb_model.predict_proba(X_train),
    xgb_model.predict_proba(X_train),
    cat_model.predict_proba(X_train)
])  # Shape: (N, 9)

# Stage 3: è®­ç»ƒå…ƒå­¦ä¹ å™¨
meta_learner = LogisticRegression(multi_class='multinomial')
meta_learner.fit(meta_train, y_train)

# Stage 4: éªŒè¯é›†è¯„ä¼°
meta_val = np.hstack([
    lgb_model.predict_proba(X_val),
    xgb_model.predict_proba(X_val),
    cat_model.predict_proba(X_val)
])
stacking_pred = meta_learner.predict(meta_val)
accuracy = accuracy_score(y_val, stacking_pred)
```

---

### é¢„æµ‹æµç¨‹ï¼ˆå®æ—¶ï¼‰

```python
# 1. è·å–æœ€æ–°Kçº¿
X_latest = get_latest_kline_features()

# 2. ä¸‰æ¨¡å‹é¢„æµ‹æ¦‚ç‡
lgb_proba = lgb_model.predict_proba(X_latest)
xgb_proba = xgb_model.predict_proba(X_latest)
cat_proba = cat_model.predict_proba(X_latest)

# 3. ç”Ÿæˆå…ƒç‰¹å¾
meta_features = np.hstack([lgb_proba, xgb_proba, cat_proba])

# 4. å…ƒå­¦ä¹ å™¨é¢„æµ‹
stacking_proba = meta_learner.predict_proba(meta_features)
final_pred = stacking_proba.argmax()
confidence = stacking_proba[final_pred]

# 5. è¿”å›ç»“æœ
signal_type = ['SHORT', 'HOLD', 'LONG'][final_pred]
return signal_type, confidence
```

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### å‡†ç¡®ç‡æå‡

| æ—¶é—´æ¡†æ¶ | å•æ¨¡å‹ | Stacking | æå‡ |
|---------|--------|---------|------|
| **15m** | 45.79% | **48-50%** | +5-9% |
| **2h** | 42.60% | **46-48%** | +8-13% |
| **4h** | 40.05% | **44-46%** | +10-15% |
| **å¹³å‡** | 42.81% | **46-48%** | **+7-12%** |

**å…³é”®**ï¼šå¹³å‡å‡†ç¡®ç‡é¢„æœŸè¾¾åˆ°**46-48%**

**å¦‚æœè¾¾åˆ°48%**ï¼š
- è·50%åªå·®2%
- å¯èƒ½é€šè¿‡å¾®è°ƒå°±èƒ½è¾¾åˆ°50%
- æˆ–è€…éœ€è¦Phase 2.4ï¼ˆè¶…å‚æ•°ä¼˜åŒ–ï¼‰

**å¦‚æœè¾¾åˆ°50%**ï¼š
- âœ… ç›´æ¥è¾¾åˆ°ç›®æ ‡
- âœ… å¯ä»¥å¼€å§‹å®æˆ˜æµ‹è¯•
- âœ… å‡†å¤‡åˆ‡æ¢å®ç›˜

---

### æ¨¡å‹æŒ‡æ ‡æ”¹å–„

**å‡†ç¡®ç‡ï¼ˆAccuracyï¼‰**ï¼š
- å½“å‰ï¼š42.81%
- é¢„æœŸï¼š48-51%

**AUCï¼ˆArea Under Curveï¼‰**ï¼š
- å½“å‰ï¼š0.56-0.61
- é¢„æœŸï¼š0.63-0.68ï¼ˆæ›´å¥½çš„åŒºåˆ†èƒ½åŠ›ï¼‰

**ç½®ä¿¡åº¦åˆ†å¸ƒ**ï¼š
- å½“å‰ï¼šé›†ä¸­åœ¨0.34-0.45
- é¢„æœŸï¼šæ›´åˆ†æ•£ï¼Œ0.40-0.65

**é¢„æµ‹å¤šæ ·æ€§**ï¼š
- å½“å‰ï¼š10å°æ—¶å†…é¢„æµ‹ç›¸åŒ
- é¢„æœŸï¼šéšå¸‚åœºåŠ¨æ€å˜åŒ–

---

## ğŸ”§ æŠ€æœ¯ä¼˜åŠ¿

### Stacking vs ç®€å•åŠ æƒ

| ç‰¹æ€§ | ç®€å•åŠ æƒ | Stacking |
|------|---------|---------|
| **æƒé‡** | å›ºå®šï¼ˆ0.4, 0.3, 0.3ï¼‰ | å­¦ä¹ å¾—åˆ° |
| **æ™ºèƒ½æ€§** | ä½ | é«˜ |
| **é€‚åº”æ€§** | å·® | å¥½ |
| **å‡†ç¡®ç‡** | +3-5% | **+5-8%** âœ… |

### ä¸‰æ¨¡å‹äº’è¡¥æ€§

**LightGBM**ï¼š
- æ“…é•¿ï¼šå¿«é€Ÿå­¦ä¹ ï¼Œç‰¹å¾é‡è¦æ€§åˆ†æ
- å¼±ç‚¹ï¼šå¯èƒ½è¿‡æ‹Ÿåˆ

**XGBoost**ï¼š
- æ“…é•¿ï¼šæ­£åˆ™åŒ–å¥½ï¼Œç¨³å®šæ€§å¼º
- å¼±ç‚¹ï¼šè®­ç»ƒè¾ƒæ…¢

**CatBoost**ï¼š
- æ“…é•¿ï¼šå¤„ç†ç±»åˆ«ç‰¹å¾ï¼ŒæŠ—è¿‡æ‹Ÿåˆ
- å¼±ç‚¹ï¼šè®­ç»ƒæœ€æ…¢

**Stackingå…ƒå­¦ä¹ å™¨**ï¼š
- å­¦ä¹ æ¯ä¸ªæ¨¡å‹ä»€ä¹ˆæ—¶å€™å‡†ç¡®
- è‡ªåŠ¨ç»„åˆå„æ¨¡å‹çš„ä¼˜åŠ¿
- é¿å…å„æ¨¡å‹çš„åŠ£åŠ¿

---

## ğŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶

### æ¨¡å‹æ–‡ä»¶ï¼ˆ12ä¸ªï¼‰

```
backend/models/
â”œâ”€â”€ ETHUSDT_15m_lgb_model.pkl   # LightGBM
â”œâ”€â”€ ETHUSDT_15m_xgb_model.pkl   # XGBoost
â”œâ”€â”€ ETHUSDT_15m_cat_model.pkl   # CatBoost
â”œâ”€â”€ ETHUSDT_15m_meta_model.pkl  # å…ƒå­¦ä¹ å™¨
â”œâ”€â”€ ETHUSDT_15m_scaler.pkl      # ç‰¹å¾ç¼©æ”¾å™¨
â”œâ”€â”€ ETHUSDT_15m_features.pkl    # ç‰¹å¾åˆ—è¡¨
â”œâ”€â”€ ETHUSDT_2h_*.pkl            # 2hæ¨¡å‹ï¼ˆ6ä¸ªæ–‡ä»¶ï¼‰
â””â”€â”€ ETHUSDT_4h_*.pkl            # 4hæ¨¡å‹ï¼ˆ6ä¸ªæ–‡ä»¶ï¼‰
```

**æ€»å¤§å°**: é¢„ä¼°20-30MB

---

## â° æ—¶é—´ä¼°ç®—

### è®­ç»ƒæ—¶é—´

| é˜¶æ®µ | æ—¶é—´ |
|------|------|
| 15mæ¨¡å‹ï¼ˆ3ä¸ªåŸºç¡€+å…ƒå­¦ä¹ å™¨ï¼‰ | 25ç§’ |
| 2hæ¨¡å‹ï¼ˆ3ä¸ªåŸºç¡€+å…ƒå­¦ä¹ å™¨ï¼‰ | 12ç§’ |
| 4hæ¨¡å‹ï¼ˆ3ä¸ªåŸºç¡€+å…ƒå­¦ä¹ å™¨ï¼‰ | 8ç§’ |
| **æ€»è®¡** | **45-60ç§’** |

### æ€»è€—æ—¶

| æ­¥éª¤ | æ—¶é—´ |
|------|------|
| å®‰è£…ä¾èµ– | 1-2åˆ†é’Ÿ |
| åˆ é™¤æ—§æ¨¡å‹ | 10ç§’ |
| ç³»ç»Ÿå¯åŠ¨ | 30ç§’ |
| **æ¨¡å‹è®­ç»ƒ** | **1åˆ†é’Ÿ** |
| WebSocketè¿æ¥ | 10ç§’ |
| **æ€»è®¡** | **3-5åˆ†é’Ÿ** |

---

## ğŸ¯ ä¸‹ä¸€æ­¥ï¼ˆå¦‚æœStackingåä»<50%ï¼‰

### Phase 2.4: è¶…å‚æ•°ä¼˜åŒ–

```bash
pip install optuna==3.5.0
```

**æ–¹æ¡ˆ**: Optunaè‡ªåŠ¨æœç´¢æœ€ä¼˜å‚æ•°

**é¢„æœŸ**: +2-4%ï¼Œè¾¾åˆ°50-54%

**å®æ–½æ—¶é—´**: 1-2å¤©

---

## âœ… æ€»ç»“

### å·²å®Œæˆ

- âœ… åˆ›å»ºensemble_ml_service.pyï¼ˆ545è¡Œï¼‰
- âœ… å®ç°Stackingä¸‰æ¨¡å‹èåˆ
- âœ… é›†æˆåˆ°ç³»ç»Ÿï¼ˆmain.pyï¼‰
- âœ… åˆ›å»ºrequirements.txt
- âœ… åˆ›å»ºå®æ–½æŒ‡å—
- âœ… é€šè¿‡è¯­æ³•æ£€æŸ¥

### å¾…æ‰§è¡Œ

1. ğŸ”¥ å®‰è£…xgboost, catboost
2. ğŸ”¥ åˆ é™¤æ—§æ¨¡å‹
3. ğŸ”¥ é‡å¯è®­ç»ƒéªŒè¯

### é¢„æœŸ

**å‡†ç¡®ç‡**: 42.81% â†’ **48-51%**  
**è·50%**: å¯èƒ½è¾¾åˆ°æˆ–æ¥è¿‘  
**å®æ–½æ—¶é—´**: 3-5åˆ†é’Ÿ

---

**æ–¹æ¡ˆ**: Stackingä¸‰æ¨¡å‹èåˆ âœ…  
**ä»£ç çŠ¶æ€**: å®Œæˆå¹¶é€šè¿‡æ£€æŸ¥ âœ…  
**ä¸‹ä¸€æ­¥**: ğŸ”¥ æ‰§è¡Œ3ä¸ªå‘½ä»¤ï¼Œå¯åŠ¨è®­ç»ƒ

