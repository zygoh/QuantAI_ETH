# 实施计划 - Informer-2 + GMADL 序列输入优化

## 任务列表

- [x] 1. 实现序列输入构造方法


  - 在`ensemble_ml_service.py`中添加`_create_sequence_input`方法
  - 实现滑动窗口逻辑，将单点特征转换为序列
  - 配置不同时间框架的序列长度（15m=96, 2h=48, 4h=24）
  - 验证输出形状为`(n_samples, seq_len, n_features)`
  - _需求: 1.1, 1.2, 1.3_

- [x] 2. 修改Informer-2模型forward方法


  - 移除`unsqueeze(1)`操作，直接接收序列输入
  - 确保输入形状为`(batch, seq_len, d_model)`
  - 验证ProbSparse注意力在seq_len>=24时正常工作
  - 验证蒸馏层正常工作（seq_len逐层减半）
  - 保持全局池化和分类头不变
  - _需求: 1.1, 1.4_

- [x] 3. 重构训练流程以支持序列输入


  - 修改`_train_ensemble_single_timeframe`方法
  - 在特征工程后调用`_create_sequence_input`构造序列
  - 更新时间序列分割逻辑以处理序列数据
  - 修改`_train_informer2`方法以接收序列输入
  - 验证训练样本数量减少（前seq_len个样本无法使用）
  - _需求: 1.1, 1.2_

- [x] 4. 实现Informer-2训练方法


  - 在`ensemble_ml_service.py`中实现`_train_informer2`方法
  - 创建PyTorch数据加载器（TensorDataset + DataLoader）
  - 实现训练循环（前向传播、损失计算、反向传播）
  - 使用GMADL损失函数（GMADLossWithHOLDPenalty）
  - 实现早停机制（如果验证损失不再下降）
  - 返回训练好的模型
  - _需求: 1.1, 1.5_

- [x] 5. 适配推理流程以支持序列输入


  - 修改`predict`方法以构造序列输入
  - 检查数据长度是否满足seq_len要求
  - 取最新seq_len个时间步构造序列
  - 转换为PyTorch张量并移动到GPU
  - 使用`torch.no_grad()`加速推理
  - _需求: 1.1_

- [x] 6. 更新元特征生成逻辑

  - 修改元特征生成代码以处理序列输入
  - 确保Informer-2的预测概率形状为`(batch, 3)`
  - 验证元特征拼接逻辑（23个特征）
  - 确保元学习器输入形状正确
  - _需求: 1.1_

- [x] 7. 优化Optuna超参数搜索空间


  - 更新Informer-2搜索空间中的`n_layers`范围（1-3）
  - 确保`d_model`能被`n_heads`整除
  - 验证序列长度与模型复杂度的匹配
  - 测试超参数优化流程
  - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 8. 验证GPU配置和加速效果

  - 确认PyTorch检测到GPU（torch.cuda.is_available()）
  - 验证模型和数据正确加载到GPU设备
  - 记录GPU加速前后的训练时间对比
  - 实现GPU内存不足时的降级策略
  - _需求: 1.1_

- [x] 9. 测试完整训练流程


  - 运行完整的训练流程（所有时间框架）
  - 验证Informer-2模型成功训练
  - 检查训练日志中的损失曲线
  - 验证模型保存和加载功能
  - 确认准确率不低于当前水平（47%）
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 10. 测试推理流程

  - 使用测试数据进行推理
  - 验证序列输入构造正确
  - 检查预测结果的置信度和概率分布
  - 验证Stacking集成正常工作
  - 测试不同时间框架的推理
  - _需求: 1.1_

- [x] 11. 性能优化和监控

  - 实现训练进度日志（每轮损失、准确率）
  - 添加GPU利用率监控
  - 优化批处理大小以平衡速度和内存
  - 实现梯度累积（如果GPU内存不足）
  - 记录训练时间和推理时间
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 12. 文档和日志优化


  - 更新代码注释说明序列输入逻辑
  - 添加详细的训练日志（序列长度、样本数量）
  - 记录关键参数配置（seq_len、d_model、n_heads）
  - 添加错误处理和降级策略的日志
  - _需求: 1.1, 2.1, 3.1_
