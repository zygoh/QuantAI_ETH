---
description: QuantAI-ETHé‡åŒ–æ™ºèƒ½äº¤æ˜“ç³»ç»Ÿ - é€šç”¨è§„åˆ™
globs:
  - "**/*"
alwaysApply: true
---

# QuantAI-ETH - é¡¹ç›®è§„åˆ™

**é¡¹ç›®å…¨ç§°**: QuantAI-ETHï¼ˆQuantitative AI for Ethereum Tradingï¼‰  
**ä¸­æ–‡åç§°**: ETHé‡åŒ–æ™ºèƒ½äº¤æ˜“ç³»ç»Ÿ  
**ç‰ˆæœ¬**: v2.0

---

## ğŸ¯ ä¸“ä¸šå®šä½ä¸è®¾è®¡ç›®æ ‡

**è§’è‰²å®šä½**: ä¸“ä¸šé‡åŒ–å¼€å‘å·¥ç¨‹å¸ˆ

**æ ¸å¿ƒè®¾è®¡ç›®æ ‡**: 
- ğŸ† **è¶…é«˜èƒœç‡ä¸­é¢‘äº¤æ˜“ç³»ç»Ÿ**ï¼ˆèƒœç‡ç›®æ ‡â‰¥60%ï¼Œç›ˆäºæ¯”â‰¥1.8:1ï¼‰
- ğŸ“Š æ¨¡å‹å‡†ç¡®ç‡â‰¥80%ï¼ˆå½“å‰å·²è¾¾æˆ81%ï¼‰
- ğŸ’° é£é™©æ§åˆ¶å®Œå–„ï¼ˆæœ€å¤§å›æ’¤<10%ï¼‰
- âš¡ ä¿¡å·è´¨é‡ä¼˜å…ˆäºæ•°é‡ï¼ˆå®ç¼ºæ¯‹æ»¥ï¼‰

**è®¾è®¡ç†å¿µ**:
- âœ… å‡†ç¡®æ€§ > ä¿¡å·é¢‘ç‡
- âœ… é£é™©æ§åˆ¶ > ç›ˆåˆ©æ¿€è¿›
- âœ… ä»£ç è´¨é‡ > å¼€å‘é€Ÿåº¦
- âœ… é•¿æœŸç¨³å®š > çŸ­æœŸæ”¶ç›Š

---

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

**QuantAI-ETH** æ˜¯ä¸€ä¸ª**ç”Ÿäº§çº§åŠ å¯†è´§å¸é‡åŒ–äº¤æ˜“ç³»ç»Ÿ**ï¼Œä½¿ç”¨å¤šæ—¶é—´æ¡†æ¶Stackingé›†æˆå­¦ä¹ è¿›è¡ŒETH/USDTåˆçº¦ä¸­é¢‘äº¤æ˜“ã€‚

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- å¤šæ—¶é—´æ¡†æ¶æ¨¡å‹è®­ç»ƒï¼ˆ15m/2h/4hç‹¬ç«‹Stackingé›†æˆæ¨¡å‹ï¼‰
- Stackingä¸‰æ¨¡å‹èåˆï¼ˆLightGBM + XGBoost + CatBoost + å…ƒå­¦ä¹ å™¨ï¼‰
- å®æ—¶ä¿¡å·ç”Ÿæˆä¸å¤šæ¨¡å‹åŠ æƒåˆæˆ
- **ä¿¡å·ç¼“å­˜æœºåˆ¶**ï¼ˆæ¯ä¸ªæ—¶é—´æ¡†æ¶ç‹¬ç«‹ç¼“å­˜é¢„æµ‹ç»“æœï¼‰
- **è®­ç»ƒåç«‹å³é¢„æµ‹**ï¼ˆå¡«å……æ‰€æœ‰æ—¶é—´æ¡†æ¶ä¿¡å·ç¼“å­˜ï¼‰
- **é¢„çƒ­ä¿¡å·ä¿æŠ¤**ï¼ˆå‰5ä¸ªä¿¡å·ä»…è®°å½•ä¸äº¤æ˜“ï¼‰
- è‡ªåŠ¨äº¤æ˜“æ‰§è¡Œä¸é£é™©ç®¡ç†
- WebSocketå®æ—¶æ•°æ®æµå¤„ç†ï¼ˆstreamåç§°ä¸­æ‰€æœ‰äº¤æ˜“å¯¹å‡ä¸ºå°å†™ï¼‰

**æŠ€æœ¯æ ˆ**ï¼šPython 3.12+ | FastAPI | LightGBM + XGBoost + CatBoost | PostgreSQL+TimescaleDB | Redis | React

**å½“å‰æ€§èƒ½**ï¼šå¹³å‡å‡†ç¡®ç‡81%ï¼ˆ15m:60%, 2h:90%, 4h:94%ï¼‰

---

## ğŸ¯ æ ¸å¿ƒæ¶æ„åŸåˆ™

### 1. Stackingé›†æˆæ¨¡å‹æ¶æ„ï¼ˆæœ€é‡è¦ï¼‰

**æ¯ä¸ªæ—¶é—´æ¡†æ¶ä½¿ç”¨ç‹¬ç«‹çš„Stackingé›†æˆ**ï¼š
```python
# âœ… æ­£ç¡®ï¼šæ¯ä¸ªæ—¶é—´æ¡†æ¶åŒ…å«4ä¸ªæ¨¡å‹
self.ensemble_models = {
    '15m': {
        'lightgbm': lgb_model,    # åŸºç¡€æ¨¡å‹1
        'xgboost': xgb_model,     # åŸºç¡€æ¨¡å‹2
        'catboost': cat_model,    # åŸºç¡€æ¨¡å‹3
        'meta_learner': meta_lgb  # å…ƒå­¦ä¹ å™¨ï¼ˆLightGBMï¼‰
    },
    '2h': {...},  # åŒæ ·çš„ç»“æ„
    '4h': {...}   # åŒæ ·çš„ç»“æ„
}
self.scalers = {'15m': scaler_15m, '2h': scaler_2h, '4h': scaler_4h}
self.feature_columns_dict = {'15m': [...], '2h': [...], '4h': [...]}
self.cached_predictions = {}  # ä¿¡å·ç¼“å­˜

# âŒ é”™è¯¯ï¼šå…±äº«æ¨¡å‹æˆ–å•æ¨¡å‹
self.model = single_model  # âŒ ä¸å…è®¸
self.models = {'15m': single_lgb}  # âŒ åº”è¯¥ç”¨Stacking
```

**Stackingè®­ç»ƒæµç¨‹**ï¼š
```python
# 1. è®­ç»ƒ3ä¸ªåŸºç¡€æ¨¡å‹ï¼ˆä¸åŒæ•°æ®é‡å¢åŠ å¤šæ ·æ€§ï¼‰
lgb_model = train_lgb(360å¤©æ•°æ®)  # HOLDæƒ©ç½š0.7
xgb_model = train_xgb(540å¤©æ•°æ®)  # HOLDæƒ©ç½š0.7
cat_model = train_cat(720å¤©æ•°æ®)  # HOLDæƒ©ç½š0.7

# 2. ç”Ÿæˆå…ƒç‰¹å¾ï¼ˆéªŒè¯é›†ï¼‰
meta_features = [lgb_proba, xgb_proba, cat_proba]

# 3. è®­ç»ƒå…ƒå­¦ä¹ å™¨ï¼ˆå…³é”®ï¼šä¹Ÿéœ€è¦HOLDæƒ©ç½šï¼ï¼‰
meta_learner = LightGBM(HOLDæƒ©ç½š=0.5)  # æ¯”åŸºç¡€æ¨¡å‹æ›´é‡çš„æƒ©ç½š
meta_learner.fit(meta_features, y_val, sample_weight=...)

# 4. ä¿å­˜æ‰€æœ‰æ¨¡å‹
```

### 2. ä¿¡å·ç”Ÿæˆæ¶æ„ï¼ˆæ ¸å¿ƒæ”¹è¿›ï¼‰

**æ­£ç¡®çš„ä¿¡å·ç”Ÿæˆæµç¨‹**ï¼š
```python
# âœ… è®­ç»ƒå®Œæˆåç«‹å³é¢„æµ‹æ‰€æœ‰æ—¶é—´æ¡†æ¶ï¼ˆå…³é”®ï¼ï¼‰
è®­ç»ƒå®Œæˆ â†’ ç«‹å³é¢„æµ‹15m+2h+4h â†’ å…¨éƒ¨ç¼“å­˜ âœ…

# âœ… å„æ—¶é—´æ¡†æ¶ç‹¬ç«‹é¢„æµ‹å¹¶ç¼“å­˜
# 15m Kçº¿å®Œæˆ â†’ é¢„æµ‹15m â†’ ç¼“å­˜15mä¿¡å·
# 2h Kçº¿å®Œæˆ  â†’ é¢„æµ‹2h  â†’ ç¼“å­˜2hä¿¡å·  
# 4h Kçº¿å®Œæˆ  â†’ é¢„æµ‹4h  â†’ ç¼“å­˜4hä¿¡å·

# âœ… åªæœ‰15mè§¦å‘åˆæˆï¼ˆ15mä½œä¸ºä¸»æ—¶é—´æ¡†æ¶ï¼‰
# 15mä¿¡å·æ›´æ–° â†’ åˆæˆæ‰€æœ‰ç¼“å­˜çš„ä¿¡å·ï¼ˆåŒ…å«4hé•¿æœŸè¶‹åŠ¿ï¼‰â†’ å‘å‡ºäº¤æ˜“ä¿¡å·

# âŒ é”™è¯¯ï¼šæ¯æ¬¡15må®Œæˆæ—¶åŒæ—¶é¢„æµ‹3ä¸ªæ—¶é—´æ¡†æ¶
# è¿™æ ·ä¼šé‡å¤é¢„æµ‹ï¼Œæ•ˆç‡ä½ä¸”æ²¡æœ‰å¿…è¦

# âŒ é”™è¯¯ï¼šè®­ç»ƒåä¸ç«‹å³é¢„æµ‹
# ä¼šå¯¼è‡´4hä¿¡å·ç¼ºå¤±ï¼ˆ4hæ¯4å°æ—¶æ‰æ›´æ–°ä¸€æ¬¡ï¼‰
```

### 3. é¢„çƒ­ä¿¡å·ä¿æŠ¤ï¼ˆç”Ÿäº§å®‰å…¨ï¼‰

**å‰5ä¸ªä¿¡å·ä»…è®°å½•ä¸äº¤æ˜“**ï¼š
```python
# ğŸ”’ å®‰å…¨ä¿æŠ¤æœºåˆ¶
self.signal_counter = 0
self.warmup_signals = 5  # é¢„çƒ­ä¿¡å·æ•°é‡

if self.signal_counter <= self.warmup_signals:
    logger.warning(f"âš ï¸ é¢„çƒ­ä¿¡å· [{self.signal_counter}/{self.warmup_signals}]ï¼šä»…è®°å½•ï¼Œä¸æ‰§è¡Œäº¤æ˜“")
    await self._save_signal(signal)  # åªä¿å­˜
    return  # ğŸ”’ ä¸å‘é€ç»™äº¤æ˜“å¼•æ“
```

**ç›®çš„**ï¼š
- è§‚å¯Ÿæ¨¡å‹ç¨³å®šæ€§
- ç¡®ä¿èµ„é‡‘å®‰å…¨
- é¿å…å¯åŠ¨åˆæœŸè¯¯æ“ä½œ

### 4. HOLDåå¥½è§£å†³æ–¹æ¡ˆï¼ˆå…³é”®ï¼‰

**é—®é¢˜**ï¼šStackingæ¨¡å‹å®¹æ˜“äº§ç”ŸHOLDåå¥½ï¼ˆ70-100%é¢„æµ‹HOLDï¼‰

**æ ¹æœ¬åŸå› **ï¼š
- åŸºç¡€æ¨¡å‹å’Œå…ƒå­¦ä¹ å™¨éƒ½å­¦åˆ°"ä¸ç¡®å®šæ—¶é€‰HOLDæœ€å®‰å…¨"
- é•¿å‘¨æœŸï¼ˆ2h/4hï¼‰HOLDç½®ä¿¡åº¦è¿‡é«˜ï¼ˆ70-80%ï¼‰
- åŠ æƒåˆæˆæ—¶å‹åˆ¶çŸ­å‘¨æœŸï¼ˆ15mï¼‰ä¿¡å·

**å®Œæ•´è§£å†³æ–¹æ¡ˆï¼ˆä¸‰å±‚é˜²æŠ¤ï¼‰**ï¼š

```python
# ç¬¬1å±‚ï¼šæºå¤´ä¿®å¤ - åŸºç¡€æ¨¡å‹HOLDæƒ©ç½š
class_weights = compute_sample_weight('balanced', y_train)
hold_penalty = np.where(y_train == 1, 0.7, 1.0)  # HOLDæƒé‡0.7
sample_weights = class_weights * time_decay * hold_penalty

lgb_model.fit(X_train, y_train, sample_weight=sample_weights)  # LightGBM
xgb_model.fit(X_train, y_train, sample_weight=sample_weights)  # XGBoost
cat_model.fit(X_train, y_train, sample_weight=sample_weights)  # CatBoost

# ç¬¬2å±‚ï¼šå…ƒå­¦ä¹ å™¨HOLDæƒ©ç½šï¼ˆæ›´é‡ï¼ï¼‰â­â­â­
meta_class_weights = compute_sample_weight('balanced', meta_labels)
meta_hold_penalty = np.where(meta_labels == 1, 0.5, 1.0)  # HOLDæƒé‡0.5ï¼ˆæ›´é‡ï¼‰
meta_sample_weights = meta_class_weights * meta_hold_penalty

meta_learner.fit(meta_features, meta_labels, sample_weight=meta_sample_weights)

# ç¬¬3å±‚ï¼šä¿¡å·åˆæˆæ—¶åŠ¨æ€é™æƒ
if timeframe in ['2h', '4h'] and signal == 'HOLD':
    if hold_confidence > 0.65:
        weight = base_weight * 0.5  # æƒé‡å‡åŠï¼Œé¿å…é•¿å‘¨æœŸHOLDå‹åˆ¶çŸ­å‘¨æœŸ
```

**å…³é”®ç‚¹**ï¼š
- âœ… åŸºç¡€æ¨¡å‹HOLDæƒ©ç½šï¼š0.7
- âœ… å…ƒå­¦ä¹ å™¨HOLDæƒ©ç½šï¼š0.5ï¼ˆ**å¿…é¡»æ›´é‡**ï¼‰
- âœ… åˆæˆæ—¶åŠ¨æ€é™æƒï¼šHOLD>0.65æ—¶å‡åŠ
- âœ… ç½®ä¿¡åº¦é˜ˆå€¼ï¼š0.35ï¼ˆé€‚åˆ81%å‡†ç¡®ç‡ï¼‰
- âœ… 15mæƒé‡70%ï¼šä¸»å¯¼å†³ç­–

**ç¦æ­¢äº‹é¡¹**ï¼š
- âŒ åªæƒ©ç½šåŸºç¡€æ¨¡å‹ï¼Œä¸æƒ©ç½šå…ƒå­¦ä¹ å™¨
- âŒ ä½¿ç”¨"é«˜ç½®ä¿¡åº¦ä¼˜å…ˆ"ç­–ç•¥ï¼ˆä¼šå¯¼è‡´4hä¿¡å·ä¸»å¯¼4å°æ—¶ï¼‰
- âŒ ç½®ä¿¡åº¦é˜ˆå€¼>0.5ï¼ˆä¼šè¿‡æ»¤å¤ªå¤šä¿¡å·ï¼‰

### 5. æ•°æ®æºåˆ†ç¦»åŸåˆ™

- **æ¨¡å‹è®­ç»ƒ**ï¼šBinance APIï¼ˆå®æ—¶è·å–æœ€æ–°æ•°æ®ï¼‰
- **ä¿¡å·ç”Ÿæˆ**ï¼šWebSocketç¼“å†²åŒºï¼ˆä¼˜å…ˆï¼‰â†’ Binance APIï¼ˆå¤‡ç”¨ï¼‰
- **æ•°æ®åº“**ï¼šä»…ç”¨äºå‰ç«¯å±•ç¤ºã€å†å²æŸ¥è¯¢ã€æ€§èƒ½åˆ†æ

### 6. æ— æœªæ¥å‡½æ•°åŸåˆ™ï¼ˆå…³é”®ï¼‰

```python
# âœ… æ­£ç¡®ï¼šåªçœ‹ä¸‹ä¸€æ ¹Kçº¿
df['next_return'] = df['close'].shift(-1) / df['close'] - 1

# âŒ é”™è¯¯ï¼šçœ‹æœªæ¥å¤šæ ¹Kçº¿
df['next_return'] = df['close'].shift(-5) / df['close'] - 1  # âŒ

# âœ… æ­£ç¡®ï¼šæ—¶é—´åºåˆ—åˆ†å‰²
split_idx = int(len(X) * 0.8)
X_train, X_val = X[:split_idx], X[split_idx:]

# âŒ é”™è¯¯ï¼šéšæœºåˆ†å‰²
X_train, X_val = train_test_split(X, y, shuffle=True)  # âŒ
```

### 7. æ—¶åŒºç»Ÿä¸€åŸåˆ™

å…¨ç³»ç»Ÿä½¿ç”¨ `Asia/Shanghai` æ—¶åŒºï¼š
```python
import pytz
from datetime import datetime

shanghai_tz = pytz.timezone('Asia/Shanghai')

# âœ… æ­£ç¡®
now = datetime.now(shanghai_tz)
ts = datetime.fromtimestamp(timestamp / 1000, tz=shanghai_tz)

# âŒ é”™è¯¯ï¼šnaive datetime
now = datetime.now()  # âŒ æ²¡æœ‰æ—¶åŒºä¿¡æ¯
```

### 8. WebSocketè®¢é˜…æ ¼å¼

**å¿…é¡»ä½¿ç”¨å°å†™äº¤æ˜“å¯¹**ï¼š
```python
# âœ… æ­£ç¡®ï¼šå°å†™
stream_name = f"{symbol.lower()}@kline_{interval}"  # ethusdt@kline_15m

# âŒ é”™è¯¯ï¼šå¤§å†™
stream_name = f"{symbol}@kline_{interval}"  # ETHUSDT@kline_15m âŒ
```

---

## ğŸ—ï¸ å…³é”®é…ç½®å‚æ•°

### æ ‡ç­¾é˜ˆå€¼ï¼ˆå·²ä¼˜åŒ–ï¼‰

```python
# âœ… å½“å‰ç”Ÿäº§é…ç½®ï¼ˆä¸­é¢‘äº¤æ˜“ï¼šçµæ•ç­–ç•¥ï¼‰
threshold_config = {
    '15m': {
        'up': 0.001,      # Â±0.1% â† ä¸­é¢‘äº¤æ˜“ï¼šæåº¦çµæ•ï¼ŒHOLD<30%
        'down': -0.001
    },
    '2h': {
        'up': 0.0035,     # Â±0.35% â† ä¸­æœŸè¾…åŠ©ï¼šHOLD<40%
        'down': -0.0035
    },
    '4h': {
        'up': 0.005,      # Â±0.5% â† é•¿æœŸç¡®è®¤ï¼šHOLD<45%
        'down': -0.005
    }
}

# é¢„æœŸæ ‡ç­¾åˆ†å¸ƒï¼ˆä¸­é¢‘äº¤æ˜“ï¼‰
# 15m: SHORT 32-38%, HOLD 24-32%, LONG 32-38%  â† çµæ•
# 2h:  SHORT 28-32%, HOLD 36-40%, LONG 28-32%  â† å¹³è¡¡
# 4h:  SHORT 26-30%, HOLD 42-46%, LONG 26-30%  â† ç¨³å¥

# âŒ è¿‡æ—¶é…ç½®ï¼ˆå¯¼è‡´ä¿¡å·è¿‡å°‘ï¼‰
# '15m': Â±0.15% â†’ HOLD 45% âŒ å¯¹ä¸­é¢‘äº¤æ˜“å¤ªä¿å®ˆ
# '15m': Â±0.3%  â†’ HOLD 74% âŒ å‡ ä¹æ— ä¿¡å·
```

### æ—¶é—´æ¡†æ¶æƒé‡

```python
# âœ… çŸ­çº¿ç­–ç•¥æƒé‡åˆ†é…
timeframe_weights = {
    '15m': 0.60,   # ä¸»å¯¼ï¼šå¿«é€Ÿæ•æ‰å…¥åœºç‚¹
    '2h': 0.25,    # è¾…åŠ©ï¼šè¶‹åŠ¿è¿‡æ»¤
    '4h': 0.15     # è¾…åŠ©ï¼šé¿å…é€†åŠ¿äº¤æ˜“
}
```

---

## ğŸ¯ ä»£ç è´¨é‡è§„èŒƒ

### ç¦æ­¢å†—ä½™

#### æ–‡ä»¶çº§åˆ«
- âŒ **ç¦æ­¢åˆ›å»ºåŠŸèƒ½é‡å¤çš„æ–‡ä»¶**
- âŒ **ç¦æ­¢åˆ›å»ºå†—ä½™æ–¹æ³•**ï¼ˆåŒä¸€é¡¹ç›®ä¸­å­˜åœ¨åŠŸèƒ½ç›¸åŒçš„æ–¹æ³•ï¼‰
- âŒ **éªŒè¯å®Œæˆä¹‹åéœ€è¦åˆ é™¤éªŒè¯æ–‡ä»¶ï¼Œç¦æ­¢ä¿å­˜å†—ä½™æ–‡ä»¶å’Œæ–¹æ³•å‡½æ•°**
- âœ… ç›¸ä¼¼åŠŸèƒ½çš„æ¨¡å—å¿…é¡»åˆå¹¶æˆ–ç»§æ‰¿åŸºç±»
- âœ… æ£€æŸ¥ç°æœ‰æ–‡ä»¶ï¼Œé¿å…é‡å¤é€ è½®å­
- âœ… è¶…è¿‡ 2 æ¬¡ä½¿ç”¨çš„ä»£ç å—å¿…é¡»æå–ä¸ºå‡½æ•°
- è¯·æ³¨æ„ï¼šä»»ä½•ä¿®æ”¹å¦‚æœæ¶‰åŠäº†è§„åˆ™æ–‡ä»¶ä¸­çš„è¯´æ˜é‚£ä¹ˆéœ€è¦æ›´æ–°è§„åˆ™æ–‡ä»¶ï¼ˆå§‹ç»ˆä¿æŒè§„åˆ™æ–‡ä»¶æœ€æ–°ã€‚ï¼‰
- æ£€æŸ¥ä¿®æ”¹åçš„ä»£ç ï¼Œå»é™¤å†—ä½™ä»£ç 
- æ£€æŸ¥æ•°æ®çš„æµè½¬ç¡®ä¿ä¸€è‡´æ€§
- æ£€æŸ¥ä»£ç æ˜¯å¦æ²¡æœ‰æŠ¥é”™é€šé¡º

#### å…¬å…±æ–¹æ³•ç®¡ç†
- å…¬å…±æ–¹æ³•ç»Ÿä¸€æ”¾åœ¨ `backend/app/utils/` æˆ– `frontend/src/utils/`
- ç›¸åŒé€»è¾‘å¿…é¡»æŠ½å–ä¸ºå·¥å…·å‡½æ•°
- é¿å…åœ¨å¤šä¸ªæ–‡ä»¶ä¸­å¤åˆ¶ç²˜è´´ç›¸åŒä»£ç 

---

### è§£è€¦åŸåˆ™

#### å•ä¸€èŒè´£
```python
# âœ… æ­£ç¡®ï¼šæ¯ä¸ªå‡½æ•°åªåšä¸€ä»¶äº‹
def fetch_data():
    """åªè´Ÿè´£è·å–æ•°æ®"""
    return data

def process_data(data):
    """åªè´Ÿè´£å¤„ç†æ•°æ®"""
    return processed

def save_data(data):
    """åªè´Ÿè´£ä¿å­˜æ•°æ®"""
    db.save(data)
```

#### ä¾èµ–æ³¨å…¥
```python
# âœ… æ­£ç¡®ï¼šé€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–
class SignalGenerator:
    def __init__(self, ml_service: MLService, data_service: DataService):
        self.ml_service = ml_service
        self.data_service = data_service

# âŒ é”™è¯¯ï¼šç›´æ¥å¯¼å…¥å…·ä½“å®ç°
class SignalGenerator:
    def __init__(self):
        from app.services.ml_service import ml_service
        self.ml_service = ml_service
```

---

## ğŸ’» ä»£ç è§„èŒƒ

### Pythonä»£ç è§„èŒƒ

```python
# 1. ç±»å‹æç¤ºï¼ˆå¿…é¡»ï¼‰
def predict(self, data: pd.DataFrame, timeframe: str) -> Dict[str, Any]:
    ...

# 2. æ–‡æ¡£å­—ç¬¦ä¸²ï¼ˆå¿…é¡»ï¼‰
def train_model(self) -> Dict[str, Any]:
    """è®­ç»ƒå¤šæ—¶é—´æ¡†æ¶æ¨¡å‹
    
    Returns:
        æ¨¡å‹æŒ‡æ ‡å­—å…¸
    """

# 3. é”™è¯¯å¤„ç†ï¼ˆå¿…é¡»ï¼‰
try:
    result = await some_operation()
except Exception as e:
    logger.error(f"æ“ä½œå¤±è´¥: {e}")
    return default_value

# 4. æ—¥å¿—è§„èŒƒï¼ˆä½¿ç”¨emojiæé«˜å¯è¯»æ€§ï¼‰
logger.info("âœ… æˆåŠŸä¿¡æ¯")
logger.warning("âš ï¸ è­¦å‘Šä¿¡æ¯")
logger.error("âŒ é”™è¯¯ä¿¡æ¯")
logger.debug("ğŸ” è°ƒè¯•ä¿¡æ¯")
```

### TypeScript/Reactä»£ç è§„èŒƒ

```typescript
// 1. ç±»å‹å®šä¹‰ï¼ˆå¿…é¡»ï¼‰
interface SignalData {
  signalType: 'LONG' | 'SHORT' | 'HOLD';
  confidence: number;
  timestamp: string;
}

// 2. å‡½æ•°ç»„ä»¶ï¼ˆä¼˜å…ˆï¼‰
const Dashboard: React.FC = () => {
  return <div>Dashboard</div>;
};

// 3. è‡ªå®šä¹‰Hookå¤ç”¨é€»è¾‘
const useSignalData = () => {
  const [signals, setSignals] = useState<SignalData[]>([]);
  // ... é€»è¾‘
  return { signals, loading, error };
};
```

---

## ğŸš« ç¦æ­¢äº‹é¡¹

### ä»£ç å±‚é¢
```python
# âŒ ç¦æ­¢ï¼šæœªæ¥å‡½æ•°
df['label'] = df['close'].shift(-5)

# âŒ ç¦æ­¢ï¼šéšæœºæ•°æ®åˆ†å‰²
train_test_split(X, y, shuffle=True)

# âŒ ç¦æ­¢ï¼šæ‰€æœ‰æ—¶é—´æ¡†æ¶å…±äº«æ¨¡å‹
self.model = single_model

# âŒ ç¦æ­¢ï¼šnaive datetime
datetime.now()  # æ²¡æœ‰æ—¶åŒº

# âŒ ç¦æ­¢ï¼šç¡¬ç¼–ç é…ç½®ï¼ˆåº”å·®å¼‚åŒ–ï¼‰
threshold = 0.005  # æ‰€æœ‰æ—¶é—´æ¡†æ¶ä½¿ç”¨ç›¸åŒå€¼

# âŒ ç¦æ­¢ï¼šåˆ›å»ºå†—ä½™æ–‡ä»¶å’Œæ–¹æ³•

# âŒ ç¦æ­¢ï¼šä¿®æ”¹ä»£ç ä¹‹åä¸åšæ£€æŸ¥å¯¼è‡´ä½çº§é”™è¯¯ï¼ˆéœ€è¦ä¿è¯ä¿®æ”¹ä¹‹åä»£ç æ²¡æœ‰è¯­æ³•é”™è¯¯ï¼‰

# âŒ ç¦æ­¢ï¼šå‡†ç¡®ç‡<50%å°±åœæ­¢ä¼˜åŒ–ï¼ˆå‡†ç¡®ç‡<50%æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼‰
```

### æ“ä½œå±‚é¢
```python
# âŒ ç¦æ­¢ï¼šåœ¨è®­ç»ƒ/é¢„æµ‹ä¸­ä¾èµ–æ•°æ®åº“
data = await postgresql_manager.query_klines()  # âŒ

# âŒ ç¦æ­¢ï¼šæ²¡æœ‰é”™è¯¯å¤„ç†çš„å…³é”®æ“ä½œ
result = critical_api_call()  # âŒ å¯èƒ½å´©æºƒ

# âŒ ç¦æ­¢ï¼šå¾ªç¯ä¾èµ–
# ServiceA imports ServiceB, ServiceB imports ServiceA  # âŒ

# âŒ ç¦æ­¢ï¼šWebSocketè®¢é˜…ä½¿ç”¨å¤§å†™äº¤æ˜“å¯¹
subscribe("ETHUSDT@kline_15m")  # âŒ åº”è¯¥ç”¨å°å†™
```

---

## âœ… æœ€ä½³å®è·µ

### 1. é…ç½®é›†ä¸­åŒ–

```python
# âœ… å·®å¼‚åŒ–é…ç½®
prediction_days_config = {
    '15m': 15,   # å¿«é€Ÿå“åº”
    '2h': 20,    # ä¸­æœŸå¹³è¡¡
    '4h': 35     # é•¿æœŸç¨³å®š
}

# âœ… é­”æ³•æ•°å­—å¸¸é‡åŒ–
BUFFER_DAYS = 60
WARMUP_SIGNALS = 5  # é¢„çƒ­ä¿¡å·æ•°é‡
MIN_SIGNAL_INTERVAL = 900
```

### 2. ç»„åˆä¼˜äºç»§æ‰¿

```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ç»„åˆ
class TradingEngine:
    def __init__(self, signal_generator, risk_manager):
        self.signal_generator = signal_generator
        self.risk_manager = risk_manager

# âš ï¸ è°¨æ…ï¼šç»§æ‰¿ï¼ˆä»…åœ¨æ˜ç¡®çš„ is-a å…³ç³»æ—¶ä½¿ç”¨ï¼‰
class AdvancedTrader(BaseTrader):
    pass
```

### 3. æ—¥å¿—æœ€ä½³å®è·µ

```python
# âœ… å…³é”®æµç¨‹å¿…é¡»è®°å½•
logger.info("ğŸš€ å¼€å§‹æ¨¡å‹è®­ç»ƒ...")
logger.info(f"ğŸ“Š {timeframe} æ•°æ®è·å–æˆåŠŸ: {len(df)}æ¡")

# âœ… ä¿¡å·ç”Ÿæˆå…¨é“¾è·¯è¿½è¸ª
logger.info(f"ğŸ“¥ æ”¶åˆ°WebSocket Kçº¿: {symbol} {interval}")
logger.info(f"ğŸ¯ {timeframe} Kçº¿å®Œæˆï¼Œå¼€å§‹é¢„æµ‹è¯¥æ—¶é—´æ¡†æ¶...")
logger.info(f"âœ… {timeframe} é¢„æµ‹å®Œæˆå¹¶ç¼“å­˜: {signal_type}")
logger.info(f"ğŸ”„ 15mä¿¡å·æ›´æ–°ï¼Œè§¦å‘åˆæˆ")

# âœ… é¢„çƒ­ä¿¡å·æ ‡æ³¨æ¸…æ™°
logger.warning(f"âš ï¸ é¢„çƒ­ä¿¡å· [{count}/{warmup}]ï¼šä»…è®°å½•ï¼Œä¸æ‰§è¡Œäº¤æ˜“")
```

---

## ğŸ“š é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ core/          # æ ¸å¿ƒé…ç½®ï¼ˆdatabase, config, cacheï¼‰
â”‚   â”œâ”€â”€ services/      # ä¸šåŠ¡æœåŠ¡ï¼ˆml, trading, signalç­‰ï¼‰
â”‚   â”œâ”€â”€ api/           # APIæ¥å£
â”‚   â”œâ”€â”€ models/        # æ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ utils/         # å…¬å…±å·¥å…·å‡½æ•° â­
â”œâ”€â”€ models/            # è®­ç»ƒå¥½çš„æ¨¡å‹æ–‡ä»¶ï¼ˆ.pklï¼‰
â”œâ”€â”€ logs/              # æ—¥å¿—æ–‡ä»¶
â””â”€â”€ main.py            # å¯åŠ¨å…¥å£

frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/    # UIç»„ä»¶
â”‚   â”œâ”€â”€ services/      # APIæœåŠ¡å’Œä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ contexts/      # å…¨å±€çŠ¶æ€
â”‚   â”œâ”€â”€ utils/         # å…¬å…±å·¥å…·å‡½æ•° â­
â”‚   â””â”€â”€ App.tsx
```

---

## ğŸ”„ å¼€å‘æµç¨‹

### æ·»åŠ æ–°åŠŸèƒ½å‰

1. **æ£€æŸ¥ç°æœ‰ä»£ç **ï¼šæ˜¯å¦å·²æœ‰ç±»ä¼¼åŠŸèƒ½ï¼Ÿ
2. **è¯„ä¼°å¤ç”¨æ€§**ï¼šèƒ½å¦æ‰©å±•ç°æœ‰æ–¹æ³•è€Œéæ–°å»ºï¼Ÿ
3. **è§„åˆ’è§£è€¦**ï¼šæ–°åŠŸèƒ½å¦‚ä½•ä¸ç°æœ‰ç³»ç»Ÿé›†æˆï¼Ÿ
4. **ç¡®å®šä½ç½®**ï¼šæ”¾åœ¨å“ªä¸ªæ¨¡å—/æœåŠ¡æœ€åˆé€‚ï¼Ÿ

### ä»£ç å®¡æŸ¥è¦ç‚¹

- [ ] æ˜¯å¦æœ‰å†—ä½™ä»£ç ï¼Ÿ
- [ ] æ˜¯å¦æœ‰é‡å¤æ–¹æ³•ï¼Ÿ
- [ ] èŒè´£æ˜¯å¦å•ä¸€ï¼Ÿ
- [ ] ä¾èµ–æ˜¯å¦æ³¨å…¥ï¼Ÿ
- [ ] æ˜¯å¦æœ‰ç±»å‹æç¤ºï¼Ÿ
- [ ] æ˜¯å¦æœ‰é”™è¯¯å¤„ç†ï¼Ÿ
- [ ] æ˜¯å¦æœ‰é€‚å½“æ³¨é‡Šï¼Ÿ
- [ ] æ—¥å¿—æ˜¯å¦å®Œæ•´å¯è¿½è¸ªï¼Ÿ

---

## ğŸ“ è®¾è®¡å“²å­¦

1. **ç‹¬ç«‹æ€§** - æ¯ä¸ªæ—¶é—´æ¡†æ¶å®Œå…¨ç‹¬ç«‹
2. **å·®å¼‚åŒ–** - æ ¹æ®ç‰¹æ€§ä½¿ç”¨ä¸åŒé…ç½®
3. **å®æ—¶æ€§** - WebSocketä¼˜å…ˆï¼Œç¼“å†²åŒºåŠ é€Ÿ
4. **å¯é æ€§** - å¤šå±‚å®¹é”™ï¼Œä¼˜é›…é™çº§
5. **å¯ç»´æŠ¤æ€§** - æ¸…æ™°æ¶æ„ï¼Œè¯¦ç»†æ—¥å¿—
6. **æ— å†—ä½™** - ä¸€ä¸ªåŠŸèƒ½ï¼Œä¸€ä¸ªå®ç° â­
7. **é«˜å†…èšä½è€¦åˆ** - æ¨¡å—ç‹¬ç«‹ï¼Œæ¥å£æ¸…æ™° â­
8. **å®‰å…¨ç¬¬ä¸€** - é¢„çƒ­ä¿æŠ¤ï¼Œèµ„é‡‘å®‰å…¨ ğŸ†•

---

---

## ğŸ›ï¸ æœåŠ¡æ¨¡å—èŒè´£çŸ©é˜µ

| æœåŠ¡æ¨¡å— | æ ¸å¿ƒèŒè´£ | ä¸åº”è¯¥åš |
|---------|---------|----------|
| **SignalGenerator** | ä¿¡å·ç”Ÿæˆã€ç¼“å­˜ã€åˆæˆã€é¢„çƒ­ä¿æŠ¤ | âŒ è®¡ç®—ä»“ä½ï¼ˆå§”æ‰˜ç»™ position_managerï¼‰ |
| **TradingEngine** | æ‰§è¡Œäº¤æ˜“ã€è™šæ‹Ÿ/å®ç›˜åˆ‡æ¢ã€è®¢å•ç®¡ç† | âŒ ç”Ÿæˆä¿¡å·ã€è®¡ç®—ä»“ä½ |
| **PositionManager** | ğŸ¯ ä»“ä½è®¡ç®—ï¼ˆå”¯ä¸€ï¼‰ã€æŸ¥è¯¢æŒä»“ã€è®¾ç½®æ æ† | âŒ ç®¡ç†æœ¬åœ°æŒä»“çŠ¶æ€ |
| **RiskService** | è®¡ç®—é£é™©æŒ‡æ ‡ã€ç”ŸæˆæŠ¥å‘Š | âŒ é˜»æ­¢äº¤æ˜“ï¼ˆä»…ä¾›å±•ç¤ºï¼‰ |
| **MLService** | æ¨¡å‹è®­ç»ƒã€é¢„æµ‹ã€ç‰¹å¾å·¥ç¨‹ | âŒ è®¿é—®æ•°æ®åº“ï¼ˆç”¨ APIï¼‰ |
| **DataService** | WebSocket æ•°æ®æµã€ç¼“å†²åŒºç®¡ç† | âŒ æ¨¡å‹è®­ç»ƒ |
| **Scheduler** | å®šæ—¶ä»»åŠ¡è°ƒåº¦ï¼ˆè®­ç»ƒã€æ›´æ–°ã€æ£€æŸ¥ï¼‰ | âŒ é‡ç½®é¢„çƒ­çŠ¶æ€ |
| **TradingController** | ç³»ç»Ÿå¯åœã€ä¿¡å·è·¯ç”±ã€ä¼šè¯ç®¡ç† | âŒ ç›´æ¥äº¤æ˜“æ‰§è¡Œ |

---

## ğŸ¯ è™šæ‹Ÿäº¤æ˜“ vs å®ç›˜äº¤æ˜“

### äº¤æ˜“æ¨¡å¼é…ç½®

```python
# config.py - å•ä¸€é…ç½®æº
TRADING_MODE: str = "SIGNAL_ONLY"  # âœ… å”¯ä¸€å­—æ®µï¼Œæ§åˆ¶æ‰€æœ‰è¡Œä¸º
```

### ä¸¤ç§æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | SIGNAL_ONLYï¼ˆé»˜è®¤ï¼‰ | AUTO |
|------|---------------------|------|
| **é…ç½®** | `TRADING_MODE="SIGNAL_ONLY"` | `TRADING_MODE="AUTO"` |
| **ä½™é¢æ¥æº** | è™šæ‹Ÿï¼ˆ10000 USDTï¼‰ | Binance API å®ç›˜ |
| **è®¢å•ç±»å‹** | è™šæ‹Ÿè®¢å•ï¼ˆæ•°æ®åº“ï¼‰ | çœŸå®è®¢å•ï¼ˆBinanceï¼‰ |
| **æ‰‹ç»­è´¹** | æ¨¡æ‹Ÿï¼ˆå¼€ä»“0.02%+å¹³ä»“0.05%ï¼‰ | çœŸå®æ‰£é™¤ |
| **é£é™©** | âœ… æ— é£é™©ï¼Œæµ‹è¯•ç­–ç•¥ | âš ï¸ çœŸå®èµ„é‡‘é£é™© |
| **åˆ‡æ¢æ–¹å¼** | API åŠ¨æ€åˆ‡æ¢ï¼Œæ— éœ€é‡å¯ | API åŠ¨æ€åˆ‡æ¢ï¼Œæ— éœ€é‡å¯ |
| **æŒä¹…åŒ–** | Redis: `system:trading_mode` | Redis: `system:trading_mode` |

### ä»“ä½è®¡ç®—é€»è¾‘

```python
# position_manager.py - ç»Ÿä¸€çš„ä»“ä½è®¡ç®—
async def calculate_position_size(
    symbol, signal_type, confidence, current_price,
    is_virtual: bool = True  # æ ¹æ®äº¤æ˜“æ¨¡å¼åŠ¨æ€ä¼ å…¥
):
    if is_virtual:
        # SIGNAL_ONLY æ¨¡å¼
        available_balance = VIRTUAL_ACCOUNT_BALANCE  # 10000 USDT
    else:
        # AUTO æ¨¡å¼
        account_info = binance_client.get_account_info()
        available_balance = float(account_info['availableBalance'])
    
    # ç»Ÿä¸€çš„è®¡ç®—é€»è¾‘
    position_ratio = 0.1 * confidence  # åŸºç¡€10% Ã— ç½®ä¿¡åº¦
    position_value = available_balance * position_ratio * leverage
    position_size = position_value / current_price
    return position_size
```

### è™šæ‹Ÿè®¢å•æ‰‹ç»­è´¹

```python
# trading_engine.py
VIRTUAL_OPEN_FEE_RATE = 0.0002   # å¼€ä»“ 0.02% (Maker)
VIRTUAL_CLOSE_FEE_RATE = 0.0005  # å¹³ä»“ 0.05% (Taker)

# å‡€ç›ˆäºè®¡ç®—
price_pnl = (exit_price - entry_price) * quantity  # ä»·å·®
open_fee = entry_price * quantity * 0.0002
close_fee = exit_price * quantity * 0.0005
net_pnl = price_pnl - open_fee - close_fee  # âœ… æ‰£é™¤åŒè¾¹æ‰‹ç»­è´¹
```

### æ¨¡å¼åˆ‡æ¢æµç¨‹

```python
# 1. é€šè¿‡ API åˆ‡æ¢ï¼ˆæ¨èï¼‰
POST /api/trading/mode
{"mode": "SIGNAL_ONLY"}  æˆ–  {"mode": "AUTO"}

# 2. å†…éƒ¨åŒæ­¥
trading_engine.set_trading_mode(mode)
    â†“
Redis["system:trading_mode"] = "SIGNAL_ONLY"  # åŒæ­¥åˆ° Redis
    â†“
signal_generator ä» Redis è¯»å–
    â†“
position_manager(is_virtual=True/False)  # åŠ¨æ€å†³å®šä½™é¢æ¥æº
```

---

## ğŸ—„ï¸ ç¼“å­˜ç­–ç•¥ä¸ Redis é”®è§„èŒƒ

### é€šç”¨ç¼“å­˜æ–¹æ³•

```python
# cache.py - åŸºç¡€æ–¹æ³•
await cache_manager.get(key)              # æ™ºèƒ½ååºåˆ—åŒ–ï¼ˆJSON/å­—ç¬¦ä¸²ï¼‰
await cache_manager.set(key, value, expire=None)  # æ™ºèƒ½åºåˆ—åŒ–ï¼Œæ”¯æŒæ°¸ä¹…ç¼“å­˜
```

### Redis é”®å‘½åè§„èŒƒ

| é”®æ¨¡å¼ | ç”¨é€” | è¿‡æœŸæ—¶é—´ | ç¤ºä¾‹ |
|--------|------|----------|------|
| `system:*` | ç³»ç»Ÿé…ç½® | âŒ æ°¸ä¹… | `system:trading_mode` |
| `warmup:*` | é¢„çƒ­çŠ¶æ€ | âŒ æ°¸ä¹… | `warmup:signal_counter:ETHUSDT` |
| `signal:*` | äº¤æ˜“ä¿¡å· | âŒ æ°¸ä¹…ï¼ˆå»é‡ç”¨ï¼‰ | `signal:last:ETHUSDT` |
| `market_data:*` | å¸‚åœºæ•°æ® | âœ… 60ç§’ | `market_data:ETHUSDT:15m` |
| `prediction:*` | æ¨¡å‹é¢„æµ‹ | âœ… 300ç§’ | `prediction:ETHUSDT` |
| `account_info` | è´¦æˆ·ä¿¡æ¯ | âœ… 30ç§’ | `account_info` |
| `position_info` | æŒä»“ä¿¡æ¯ | âœ… 30ç§’ | `position_info` |

### ç¼“å­˜è®¾è®¡åŸåˆ™

```python
# âœ… å…³é”®çŠ¶æ€æ°¸ä¹…ç¼“å­˜
await cache_manager.set("system:trading_mode", mode, expire=None)
await cache_manager.set("warmup:signal_counter:ETHUSDT", count, expire=None)

# âœ… ä¸´æ—¶æ•°æ®è®¾ç½®è¿‡æœŸ
await cache_manager.set("market_data:ETHUSDT:15m", data, expire=60)

# âœ… å¤„ç† None å€¼
await cache_manager.set(key, None, expire=None)  # è‡ªåŠ¨è·³è¿‡ï¼Œä¸æŠ¥é”™
```

### å¸¸è§é”™è¯¯å¤„ç†

```python
# âŒ é”™è¯¯ï¼šexpire=None å¯¼è‡´ setex å¤±è´¥
await redis.client.setex(key, None, value)  # Invalid input type: NoneType

# âœ… æ­£ç¡®ï¼šåŒºåˆ†æ°¸ä¹…å’Œä¸´æ—¶ç¼“å­˜
if expire is None:
    await redis.client.set(key, value)  # æ°¸ä¹…
else:
    await redis.client.setex(key, expire, value)  # ä¸´æ—¶
```

---

## ğŸ”„ æ•°æ®æµä¸çŠ¶æ€åŒæ­¥

### é¢„çƒ­çŠ¶æ€æŒä¹…åŒ–

```python
# âœ… å¯åŠ¨æ—¶åŠ è½½
async def _load_warmup_state(self):
    cached_counter = await cache_manager.get(f"warmup:signal_counter:{settings.SYMBOL}")
    if cached_counter is not None:
        self.signal_counter = int(cached_counter)
        logger.info(f"ğŸ“‚ å·²åŠ è½½é¢„çƒ­çŠ¶æ€: {self.signal_counter}/5")
    else:
        logger.info(f"ğŸ“‚ é¦–æ¬¡éƒ¨ç½²ï¼Œåˆå§‹åŒ–é¢„çƒ­çŠ¶æ€: 0/5")

# âœ… æ¯æ¬¡è®¡æ•°åä¿å­˜
self.signal_counter += 1
await self._save_warmup_state()  # ç«‹å³æŒä¹…åŒ–

# âŒ é”™è¯¯ï¼šå®šæœŸè®­ç»ƒé‡ç½®é¢„çƒ­çŠ¶æ€
# è®­ç»ƒå®Œæˆåä¸åº”è¯¥è§¦å‘ _initial_predictions()
```

### äº¤æ˜“æ¨¡å¼åŒæ­¥

```python
# âœ… å¯åŠ¨æ—¶åŒæ­¥åˆ° Redis
async def start(self):
    await self._sync_trading_mode_to_cache()

# âœ… åˆ‡æ¢æ—¶ç«‹å³åŒæ­¥
async def set_trading_mode(self, mode):
    self.trading_mode = mode
    await self._sync_trading_mode_to_cache()  # åŒæ­¥åˆ° Redis

# âœ… å…¶ä»–æ¨¡å—åŠ¨æ€è¯»å–
current_mode = await cache_manager.get("system:trading_mode")
is_virtual = (current_mode != "AUTO")
```

---

## ğŸ› å¸¸è§é”™è¯¯æ¨¡å¼ä¸ä¿®å¤

### é”™è¯¯1ï¼šdatetime åºåˆ—åŒ–

```python
# âŒ é”™è¯¯ï¼šç›´æ¥å­˜å‚¨ datetime
predictions = {
    '15m': {'timestamp': datetime.now()}  # âŒ JSON ä¸æ”¯æŒ
}
await postgresql_manager.write_signal_data({'predictions': predictions})
# Error: Object of type datetime is not JSON serializable

# âœ… æ­£ç¡®ï¼šè½¬æ¢ä¸º ISO å­—ç¬¦ä¸²
for tf, pred in predictions.items():
    if 'timestamp' in pred and hasattr(pred['timestamp'], 'isoformat'):
        pred['timestamp'] = pred['timestamp'].isoformat()
```

### é”™è¯¯2ï¼šCacheManager ç¼ºå°‘æ–¹æ³•

```python
# âŒ é”™è¯¯ï¼šè°ƒç”¨ä¸å­˜åœ¨çš„æ–¹æ³•
await cache_manager.get(key)  # AttributeError: no attribute 'get'
await cache_manager.set(key, value)  # AttributeError: no attribute 'set'

# âœ… æ­£ç¡®ï¼šå¿…é¡»å®ç°é€šç”¨ get/set æ–¹æ³•
class CacheManager:
    async def get(self, key: str) -> Optional[Any]:
        # é€šç”¨è·å–ï¼Œè‡ªåŠ¨ JSON ååºåˆ—åŒ–
        
    async def set(self, key: str, value: Any, expire: Optional[int] = None):
        # é€šç”¨è®¾ç½®ï¼Œæ”¯æŒæ°¸ä¹…ç¼“å­˜ï¼ˆexpire=Noneï¼‰
```

### é”™è¯¯3ï¼šNone å€¼ç¼“å­˜

```python
# âŒ é”™è¯¯ï¼šRedis ä¸æ¥å— None
await cache_manager.set(key, None, expire=None)
# Error: Invalid input of type: 'NoneType'

# âœ… æ­£ç¡®ï¼šæ£€æŸ¥å¹¶è·³è¿‡
if value is None:
    logger.debug(f"è·³è¿‡è®¾ç½®ç¼“å­˜ï¼ˆå€¼ä¸ºNoneï¼‰")
    return
```

### é”™è¯¯4ï¼šè™šæ‹Ÿæ¨¡å¼æŸ¥è¯¢å®ç›˜ä½™é¢

```python
# âŒ é”™è¯¯ï¼šSIGNAL_ONLY æ¨¡å¼æŸ¥è¯¢å®ç›˜è´¦æˆ·
account_info = binance_client.get_account_info()  # è¿”å› 0 USDT
if available_balance <= 0:
    logger.warning("å¯ç”¨ä½™é¢ä¸è¶³")  # åå¤æŠ¥é”™

# âœ… æ­£ç¡®ï¼šæ ¹æ®æ¨¡å¼é€‰æ‹©ä½™é¢
if is_virtual:
    available_balance = 10000.0  # è™šæ‹Ÿä½™é¢
else:
    account_info = binance_client.get_account_info()
    available_balance = float(account_info['availableBalance'])
```

### é”™è¯¯5ï¼šWebSocket é”™è¯¯ä¸é‡è¿

```python
# âŒ é”™è¯¯ï¼šåªåœ¨ _on_close è§¦å‘é‡è¿
def _on_error(self, ws, error):
    logger.error(f"é”™è¯¯: {error}")  # åªè®°å½•ï¼Œä¸é‡è¿

# âœ… æ­£ç¡®ï¼šerror ä¹Ÿè§¦å‘é‡è¿
def _on_error(self, ws, error):
    self.is_connected = False
    if self.is_running and not self.is_reconnecting:
        self.is_reconnecting = True  # ğŸ”’ é˜²é‡å¤
        asyncio.run_coroutine_threadsafe(self._reconnect(), self.loop)
```

### é”™è¯¯6ï¼šä»£ç é‡å¤

```python
# âŒ é”™è¯¯ï¼šåŒä¸€åŠŸèƒ½å†™ä¸¤é
# signal_generator.py
async def _calculate_position_size(...):
    position_ratio = 0.1 * confidence
    ...

# position_manager.py
async def calculate_position_size(...):
    position_ratio = 0.1 * confidence
    ...  # å®Œå…¨ç›¸åŒçš„é€»è¾‘

# âœ… æ­£ç¡®ï¼šç»Ÿä¸€ä½¿ç”¨ position_manager
from app.services.position_manager import position_manager
position_size = await position_manager.calculate_position_size(...)
```

---

## ğŸ“Š é…ç½®ç®¡ç†æœ€ä½³å®è·µ

### å•ä¸€é…ç½®æºåŸåˆ™

```python
# âœ… æ­£ç¡®ï¼šåªç”¨ä¸€ä¸ªå­—æ®µæ§åˆ¶
TRADING_MODE: str = "SIGNAL_ONLY"

# âŒ é”™è¯¯ï¼šå†—ä½™å­—æ®µ
TRADING_MODE: str = "SIGNAL_ONLY"
AUTO_TRADING_ENABLED: bool = False  # âŒ å¯ä»¥ä» TRADING_MODE æ¨å¯¼
```

### é…ç½®è¯»å–é¡ºåº

```
1. config.pyï¼ˆé»˜è®¤å€¼ï¼‰
   â†“
2. .env æ–‡ä»¶ï¼ˆè¦†ç›–ï¼‰
   â†“
3. Redis è¿è¡Œæ—¶çŠ¶æ€ï¼ˆåŠ¨æ€åˆ‡æ¢ï¼‰
   â†“
4. API è°ƒç”¨ï¼ˆå³æ—¶ç”Ÿæ•ˆï¼‰
```

### å·®å¼‚åŒ–é…ç½®ç¤ºä¾‹

```python
# âœ… æ­£ç¡®ï¼šæ ¹æ®æ—¶é—´æ¡†æ¶ç‰¹æ€§é…ç½®
threshold_config = {
    '15m': {'up': 0.001, 'down': -0.001},   # çŸ­çº¿çµæ•
    '2h': {'up': 0.0035, 'down': -0.0035},  # ä¸­æœŸå¹³è¡¡
    '4h': {'up': 0.005, 'down': -0.005}     # é•¿æœŸç¨³å¥
}

training_days_config = {
    '15m': 180,  # çŸ­æœŸæ•°æ®å……è¶³
    '2h': 360,   # ä¸­æœŸéœ€è¦æ›´å¤š
    '4h': 540    # é•¿æœŸéœ€è¦æœ€å¤š
}

# âŒ é”™è¯¯ï¼šæ‰€æœ‰æ—¶é—´æ¡†æ¶ç”¨ç›¸åŒé…ç½®
threshold = 0.005  # ä¸åˆç†ï¼Œåº”å·®å¼‚åŒ–
```

---

## ğŸ”§ å¸¸é‡å‘½åè§„èŒƒ

```python
# è™šæ‹Ÿäº¤æ˜“å¸¸é‡ï¼ˆå¤§å†™ï¼Œæ¨¡å—çº§ï¼‰
VIRTUAL_ACCOUNT_BALANCE = 10000.0
VIRTUAL_OPEN_FEE_RATE = 0.0002
VIRTUAL_CLOSE_FEE_RATE = 0.0005

# ç³»ç»Ÿå¸¸é‡
BUFFER_DAYS = 60
WARMUP_SIGNALS = 5
MIN_SIGNAL_INTERVAL = 900

# âŒ ç¦æ­¢ï¼šé­”æ³•æ•°å­—
position_value = balance * 0.1  # âŒ 0.1 æ˜¯ä»€ä¹ˆï¼Ÿ
# âœ… åº”è¯¥ï¼š
BASE_POSITION_RATIO = 0.1  # åŸºç¡€10%ä»“ä½
position_value = balance * BASE_POSITION_RATIO
```

---

## ğŸ”„ å¼‚æ­¥ç¼–ç¨‹æœ€ä½³å®è·µ

### æ­£ç¡®çš„å¼‚æ­¥è°ƒç”¨

```python
# âœ… I/O æ“ä½œå¿…é¡»å¼‚æ­¥
async def fetch_data(symbol: str):
    return await binance_client.get_klines(symbol)

# âœ… CPU å¯†é›†å‹å¯ä»¥åŒæ­¥
def train_model(X, y):
    model = lgb.train(params, train_set)
    return model

# âŒ é”™è¯¯ï¼šåŒæ­¥ I/O é˜»å¡
def fetch_data(symbol: str):
    return requests.get(url)  # âŒ é˜»å¡äº‹ä»¶å¾ªç¯
```

### è·¨çº¿ç¨‹è°ƒç”¨

```python
# âœ… æ­£ç¡®ï¼šWebSocket å›è°ƒï¼ˆå­çº¿ç¨‹ï¼‰è°ƒç”¨ä¸»äº‹ä»¶å¾ªç¯
def _on_close(self, ws):
    if self.loop:
        future = asyncio.run_coroutine_threadsafe(
            self._reconnect(), 
            self.loop  # æäº¤åˆ°ä¸»äº‹ä»¶å¾ªç¯
        )
        self.reconnect_task = future  # ä¿å­˜ future é˜²æ­¢ GC

# âŒ é”™è¯¯ï¼šç›´æ¥è°ƒç”¨ async å‡½æ•°
def _on_close(self, ws):
    await self._reconnect()  # âŒ åŒæ­¥å‡½æ•°ä¸èƒ½ await
```

---

## ğŸš« æœ¬æ¬¡ä¼šè¯ä¿®å¤çš„é”™è¯¯ï¼ˆè®°å½•ï¼‰

### ä¿®å¤æ¸…å•

1. âœ… ç½®ä¿¡åº¦è¿‡æ»¤æ—¥å¿—ä¸æ˜¾ç¤º â†’ æ”¹ä¸º INFO çº§åˆ«
2. âœ… é¢„çƒ­çŠ¶æ€ä¸æŒä¹…åŒ– â†’ æ·»åŠ  Redis æŒä¹…åŒ–
3. âœ… å®šæœŸè®­ç»ƒé‡ç½®é¢„çƒ­ â†’ åˆ é™¤è®­ç»ƒåè§¦å‘é¢„æµ‹
4. âœ… CacheManager ç¼º get/set â†’ æ·»åŠ é€šç”¨æ–¹æ³•
5. âœ… None å€¼åºåˆ—åŒ–é”™è¯¯ â†’ æ·»åŠ  None å¤„ç†
6. âœ… datetime åºåˆ—åŒ–é”™è¯¯ â†’ è½¬æ¢ä¸º ISO å­—ç¬¦ä¸²
7. âœ… è™šæ‹Ÿæ¨¡å¼ä½™é¢ä¸è¶³ â†’ æ·»åŠ è™šæ‹Ÿä½™é¢æ”¯æŒï¼ˆ10000ï¼‰
8. âœ… è™šæ‹Ÿè®¢å•æ— æ‰‹ç»­è´¹ â†’ æ·»åŠ  0.02%/0.05%
9. âœ… äº¤æ˜“æ¨¡å¼é…ç½®å†—ä½™ â†’ åˆ é™¤ AUTO_TRADING_ENABLED
10. âœ… ä»£ç é‡å¤ï¼ˆä»“ä½è®¡ç®—ï¼‰ â†’ ç»Ÿä¸€åˆ° position_manager
11. âœ… WebSocket é”™è¯¯ä¸é‡è¿ â†’ _on_error è§¦å‘é‡è¿
12. âœ… é‡å¤é‡è¿é£é™© â†’ æ·»åŠ  is_reconnecting é”
13. âœ… é‡è¿å¤±è´¥ä¸å†å°è¯• â†’ å¤±è´¥åå†æ¬¡è°ƒåº¦

---

## ğŸ¯ æ¶æ„è®¾è®¡åŸåˆ™ï¼ˆæ›´æ–°ï¼‰

### 1. å•ä¸€èŒè´£åŸåˆ™ï¼ˆSRPï¼‰
- æ¯ä¸ªæœåŠ¡æ¨¡å—åªè´Ÿè´£ä¸€ä»¶äº‹
- ä»“ä½è®¡ç®—**åªåœ¨** position_manager
- ä¿¡å·ç”Ÿæˆ**åªåœ¨** signal_generator
- äº¤æ˜“æ‰§è¡Œ**åªåœ¨** trading_engine

### 2. ä¾èµ–æ³¨å…¥åŸåˆ™ï¼ˆDIï¼‰
- é€šè¿‡æ„é€ å‡½æ•°ä¼ é€’ä¾èµ–
- é¿å…åœ¨ç±»å†…éƒ¨ç›´æ¥å¯¼å…¥å…¨å±€å®ä¾‹
- ä¾¿äºæµ‹è¯•å’Œè§£è€¦

### 3. é…ç½®é›†ä¸­åŒ–
- æ‰€æœ‰é…ç½®åœ¨ config.py
- å•ä¸€æ•°æ®æºï¼Œé¿å…å†—ä½™
- æ”¯æŒ .env æ–‡ä»¶è¦†ç›–

### 4. çŠ¶æ€æŒä¹…åŒ–
- å…³é”®çŠ¶æ€å­˜å‚¨åˆ° Redisï¼ˆé¢„çƒ­ã€äº¤æ˜“æ¨¡å¼ï¼‰
- é‡å¯åæ¢å¤ï¼Œé¿å…ä¸­æ–­
- æ”¯æŒåŠ¨æ€åˆ‡æ¢ï¼Œæ— éœ€é‡å¯

### 5. é”™è¯¯ä¼˜é›…é™çº§
- WebSocket æ–­å¼€ â†’ è‡ªåŠ¨é‡è¿
- ç¼“å­˜å¤±è´¥ â†’ é™çº§åˆ° API
- æ¨¡å‹æœªè®­ç»ƒ â†’ ç­‰å¾…è®­ç»ƒå®Œæˆ

---

## ğŸš€ ç³»ç»Ÿä¼˜åŒ–è§„èŒƒ

### 1. æ€§èƒ½ä¼˜åŒ–åŸåˆ™

**å…³é”®æŒ‡æ ‡**ï¼š
- æ¨¡å‹å‡†ç¡®ç‡ï¼š**å·²è¾¾æˆ81%**ï¼ˆ15m:60%, 2h:90%, 4h:94%ï¼‰âœ… è¶…é¢å®Œæˆ
- å®é™…ä¿¡å·å‡†ç¡®ç‡ï¼šåŸºæœ¬è¦æ±‚ â‰¥50%ï¼Œç›®æ ‡ â‰¥55%ï¼Œé•¿æœŸç›®æ ‡ â‰¥60%
- é¢„æµ‹å»¶è¿Ÿï¼šç›®æ ‡ <1ç§’
- ç³»ç»Ÿç¨³å®šæ€§ï¼šç›®æ ‡ 99.9%

**æ€§èƒ½åŸºå‡†**ï¼ˆä¸‰åˆ†ç±»ï¼‰ï¼š
- éšæœºçŒœæµ‹: 33.3%
- åŸºæœ¬å¯ç”¨: **50%** â† æœ€ä½è¦æ±‚
- è‰¯å¥½: 55%
- ä¼˜ç§€: 60%+

### 2. ä¼˜åŒ–ä¼˜å…ˆçº§

**ç«‹å³æ‰§è¡Œ** â­â­â­ï¼š
- æ ‡ç­¾é˜ˆå€¼é…ç½®ä¿®å¤ï¼ˆ15m: Â±0.1%, 2h: Â±0.35%, 4h: Â±0.5%ï¼‰
- ç½®ä¿¡åº¦é˜ˆå€¼è°ƒæ•´ï¼ˆ0.44 â†’ 0.40ï¼‰
- æ ·æœ¬åŠ æƒè®­ç»ƒï¼ˆè§£å†³ç±»åˆ«ä¸å¹³è¡¡ï¼‰
- åŠ¨æ€ä»“ä½ç®¡ç†ï¼ˆæ ¹æ®å¸‚åœºçŠ¶æ€è°ƒæ•´ï¼‰
- åŠ¨æ€æ­¢æŸæ­¢ç›ˆï¼ˆåŸºäºATRï¼‰

**çŸ­æœŸä¼˜åŒ–** â­â­ï¼ˆ1-2å‘¨ï¼‰ï¼š
- å¸‚åœºå¾®è§‚ç»“æ„ç‰¹å¾ï¼ˆä¹°å–å‹åŠ›ã€Kçº¿å½¢æ€ï¼‰
- æ¨¡å‹é›†æˆï¼ˆLightGBM + XGBoost + CatBoostï¼‰
- å¸‚åœºæƒ…ç»ªç‰¹å¾ï¼ˆææ…ŒæŒ‡æ•°ã€è¿ç»­æ¶¨è·Œï¼‰
- ä¿¡å·å¢å¼ºè¿‡æ»¤ï¼ˆè¶‹åŠ¿ä¸€è‡´æ€§ã€é‡èƒ½ç¡®è®¤ï¼‰
- å›æ’¤ä¿æŠ¤æœºåˆ¶ï¼ˆåˆ†çº§ä¿æŠ¤ï¼‰

**ä¸­æœŸä¼˜åŒ–** â­ï¼ˆ1-2æœˆï¼‰ï¼š
- å¤šæ—¶é—´æ¡†æ¶ç‰¹å¾èåˆï¼ˆé•¿å‘¨æœŸè¶‹åŠ¿èå…¥çŸ­å‘¨æœŸï¼‰
- åŠ¨æ€æ ‡ç­¾é˜ˆå€¼ï¼ˆæ ¹æ®æ³¢åŠ¨ç‡è°ƒæ•´ï¼‰
- è¶…å‚æ•°è‡ªåŠ¨ä¼˜åŒ–ï¼ˆOptunaï¼‰
- ç‰¹å¾ç¼“å­˜æœºåˆ¶ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
- å®æ—¶æ€§èƒ½ç›‘æ§

**é•¿æœŸæ¢ç´¢**ï¼š
- å¤šç›®æ ‡æ ‡ç­¾ï¼ˆæ–¹å‘+å¹…åº¦+æŒç»­æ—¶é—´ï¼‰
- å¼ºåŒ–å­¦ä¹ 
- A/Bæµ‹è¯•æ¡†æ¶
- å¢é‡ç‰¹å¾è®¡ç®—

### 3. ç‰¹å¾å·¥ç¨‹è§„èŒƒ

**ç¦æ­¢äº‹é¡¹**ï¼š
- âŒ æ·»åŠ æœªæ¥å‡½æ•°ï¼ˆä½¿ç”¨æœªæ¥æ•°æ®ï¼‰
- âŒ è¿‡åº¦æ‹Ÿåˆï¼ˆç‰¹å¾æ•°>æ ·æœ¬æ•°/10ï¼‰
- âŒ é‡å¤ç‰¹å¾ï¼ˆç›¸å…³ç³»æ•°>0.95ï¼‰
- âŒ å¿½ç•¥å¼‚å¸¸å€¼å¤„ç†

**æœ€ä½³å®è·µ**ï¼š
- âœ… ç‰¹å¾æ ‡å‡†åŒ–/å½’ä¸€åŒ–
- âœ… ç§»é™¤é«˜ç¼ºå¤±ç‡ç‰¹å¾ï¼ˆ>20%ï¼‰
- âœ… ç‰¹å¾é‡è¦æ€§åˆ†æï¼ˆä¿ç•™Top 50ï¼‰
- âœ… äº¤å‰éªŒè¯é˜²æ­¢è¿‡æ‹Ÿåˆ
- âœ… å¢é‡è®¡ç®—æå‡æ•ˆç‡

### 4. æ¨¡å‹è®­ç»ƒè§„èŒƒ

**å·®å¼‚åŒ–é…ç½®**ï¼ˆå¿…é¡»éµå®ˆï¼‰ï¼š
```python
# æ ‡ç­¾é˜ˆå€¼ï¼ˆå…³é”®é…ç½®ï¼‰
'15m': Â±0.1%  (0.001)   # ç›®æ ‡HOLD 24-32%
'2h': Â±0.35% (0.0035)  # ç›®æ ‡HOLD 36-40%
'4h': Â±0.5%  (0.005)   # ç›®æ ‡HOLD 42-46%

# è®­ç»ƒå¤©æ•°
'15m': 180å¤©  # çŸ­æœŸæ•°æ®å……è¶³
'2h': 270å¤©   # ä¸­æœŸéœ€è¦æ›´å¤š
'4h': 360å¤©   # é•¿æœŸéœ€è¦æœ€å¤š

# æ¨¡å‹å¤æ‚åº¦
'15m': num_leaves=127  # æ•°æ®å¤šï¼Œæ¨¡å‹å¤æ‚
'2h': num_leaves=63    # ä¸­ç­‰
'4h': num_leaves=47    # æ•°æ®å°‘ï¼Œæ¨¡å‹ç®€å•
```

**æ ·æœ¬æƒé‡ç­–ç•¥**ï¼š
```python
# 1. ç±»åˆ«æƒé‡ï¼ˆè§£å†³ä¸å¹³è¡¡ï¼‰
class_weights = compute_sample_weight('balanced', y_train)

# 2. æ—¶é—´è¡°å‡æƒé‡ï¼ˆé‡è§†æœ€è¿‘æ•°æ®ï¼‰
time_decay = np.exp(-np.arange(len(X)) / (len(X) * 0.1))[::-1]

# 3. ç»„åˆæƒé‡
sample_weights = class_weights * time_decay
```

### 5. é£é™©ç®¡ç†è§„èŒƒ

**åŠ¨æ€ä»“ä½è®¡ç®—**ï¼š
```python
# åŸºç¡€ä»“ä½
base_ratio = 0.1 * confidence  # æœ€é«˜10%

# è°ƒæ•´å› å­
volatility_adj = f(å¸‚åœºæ³¢åŠ¨ç‡)     # 0.5-1.5
exposure_adj = f(å½“å‰æŒä»“)         # 0.5-1.0
loss_adj = f(è¿ç»­äºæŸæ¬¡æ•°)         # 0.5-1.0

# æœ€ç»ˆä»“ä½
position_ratio = base_ratio * volatility_adj * exposure_adj * loss_adj
position_ratio = clip(position_ratio, 0.02, 0.15)  # é™åˆ¶2%-15%
```

**å›æ’¤ä¿æŠ¤**ï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰ï¼š
```python
# åˆ†çº§ä¿æŠ¤
if drawdown > 15%: æš‚åœäº¤æ˜“
elif drawdown > 10%: ä»“ä½é™è‡³50%
elif drawdown > 5%: ä»“ä½é™è‡³75%

# æ¢å¤æ¡ä»¶
if drawdown < 3%: æ¢å¤æ­£å¸¸äº¤æ˜“
```

### 6. ç³»ç»Ÿæ€§èƒ½è§„èŒƒ

**å“åº”æ—¶é—´è¦æ±‚**ï¼š
- ç‰¹å¾è®¡ç®—ï¼š<500ms
- æ¨¡å‹é¢„æµ‹ï¼š<200ms
- ä¿¡å·ç”Ÿæˆï¼š<1000ms
- è®¢å•æ‰§è¡Œï¼š<2000ms

**ä¼˜åŒ–ç­–ç•¥**ï¼š
- ç‰¹å¾ç¼“å­˜ï¼ˆæœ€è¿‘100ä¸ªï¼‰
- å¢é‡è®¡ç®—ï¼ˆåªè®¡ç®—æ–°Kçº¿ï¼‰
- GPUåŠ é€Ÿï¼ˆå¦‚æœå¯ç”¨ï¼‰
- å¼‚æ­¥å¹¶å‘ï¼ˆI/Oæ“ä½œï¼‰

### 7. ç›‘æ§æŒ‡æ ‡

**å¿…é¡»ç›‘æ§**ï¼š
- æ¨¡å‹å‡†ç¡®ç‡ï¼ˆæ¯æ¬¡è®­ç»ƒåï¼‰
- å®é™…ä¿¡å·å‡†ç¡®ç‡ï¼ˆå®æ—¶æ›´æ–°ï¼‰
- èƒœç‡ï¼ˆ7æ—¥/30æ—¥ï¼‰
- ç›ˆäºæ¯”ï¼ˆ7æ—¥/30æ—¥ï¼‰
- æœ€å¤§å›æ’¤ï¼ˆå®æ—¶ï¼‰
- å¤æ™®æ¯”ç‡ï¼ˆ30æ—¥ï¼‰
- ä¿¡å·æ•°é‡ï¼ˆæ—¥å‡ï¼‰
- ç³»ç»Ÿå»¶è¿Ÿï¼ˆp99ï¼‰

**å‘Šè­¦é˜ˆå€¼**ï¼š
```python
if win_rate < 45%: å‘é€å‘Šè­¦
if drawdown > 10%: ç´§æ€¥å‘Šè­¦
if accuracy < 40%: æ¨¡å‹éœ€é‡è®­
if latency_p99 > 3s: æ€§èƒ½å‘Šè­¦
```

### 8. ä¼˜åŒ–æ–‡æ¡£è§„èŒƒ

**å¿…é¡»æ–‡æ¡£åŒ–**ï¼š
- æ¯æ¬¡ä¼˜åŒ–çš„ç›®æ ‡ã€æ–¹æ³•ã€ç»“æœ
- A/Bæµ‹è¯•å¯¹æ¯”æ•°æ®
- å‚æ•°è°ƒæ•´å‰åå¯¹æ¯”
- å¤±è´¥çš„å°è¯•å’ŒåŸå› 

**æ–‡æ¡£ä½ç½®**ï¼š
- æ€»ä½“è§„åˆ’ï¼š`OPTIMIZATION_ROADMAP.md`
- å®æ–½è®°å½•ï¼š`docs/optimization/`
- æ€§èƒ½æŠ¥å‘Šï¼š`docs/performance/`

### 9. ä»£ç è´¨é‡è§„èŒƒ

**ä¼˜åŒ–ç›¸å…³ä»£ç å¿…é¡»**ï¼š
- æ·»åŠ è¯¦ç»†æ³¨é‡Šï¼ˆè¯´æ˜ä¼˜åŒ–ç›®çš„ï¼‰
- åŒ…å«æ€§èƒ½æµ‹è¯•ï¼ˆbefore/afterï¼‰
- å¯é…ç½®å¼€å…³ï¼ˆä¾¿äºå¯¹æ¯”ï¼‰
- å‘åå…¼å®¹ï¼ˆä¸ç ´åç°æœ‰åŠŸèƒ½ï¼‰

**ç¤ºä¾‹**ï¼š
```python
# âœ… å¥½çš„ä¼˜åŒ–ä»£ç 
def create_features_cached(self, df: pd.DataFrame) -> pd.DataFrame:
    """
    åˆ›å»ºç‰¹å¾ï¼ˆå¸¦ç¼“å­˜ä¼˜åŒ–ï¼‰
    
    ä¼˜åŒ–ç›®æ ‡ï¼šå‡å°‘é‡å¤è®¡ç®—ï¼Œæå‡å“åº”é€Ÿåº¦50%+
    
    Args:
        df: åŸå§‹Kçº¿æ•°æ®
    
    Returns:
        å¸¦ç‰¹å¾çš„DataFrame
    
    Performance:
        Before: ~800ms
        After:  ~300ms (ç¼“å­˜å‘½ä¸­æ—¶)
    """
    # ... å®ç°
```

### 10. æµ‹è¯•è§„èŒƒ

**ä¼˜åŒ–å¿…é¡»æµ‹è¯•**ï¼š
- å•å…ƒæµ‹è¯•ï¼ˆæ–°å¢åŠŸèƒ½ï¼‰
- æ€§èƒ½æµ‹è¯•ï¼ˆbefore/afterå¯¹æ¯”ï¼‰
- å›æµ‹éªŒè¯ï¼ˆå†å²æ•°æ®ï¼‰
- å‹åŠ›æµ‹è¯•ï¼ˆæç«¯æƒ…å†µï¼‰

**æµ‹è¯•é€šè¿‡æ ‡å‡†**ï¼š
- å‡†ç¡®ç‡æå‡ â‰¥2%ï¼ˆæˆ–å…¶ä»–ç›®æ ‡æŒ‡æ ‡ï¼‰
- æ— æ€§èƒ½é€€åŒ–ï¼ˆå»¶è¿Ÿä¸å¢åŠ ï¼‰
- æ— åŠŸèƒ½ç ´åï¼ˆç°æœ‰åŠŸèƒ½æ­£å¸¸ï¼‰
- ä»£ç è¦†ç›–ç‡ â‰¥80%

---

## ğŸ“ ä¸“ä¸šé‡åŒ–å·¥ç¨‹å¸ˆä»£ç è§„èŒƒ

**é¡¹ç›®**: QuantAI-ETH  
**é‡è¦æ€§**: ğŸ”´ **CRITICAL** - å¿…é¡»ä¸¥æ ¼éµå®ˆ  
**ç›®æ ‡**: é¿å…ä½çº§é”™è¯¯ï¼Œç¡®ä¿ä»£ç è´¨é‡

---

### 1. ä»£ç è´¨é‡åŸºæœ¬è¦æ±‚

#### 1.1 é›¶å®¹å¿é”™è¯¯

**ä¸¥æ ¼ç¦æ­¢ä»¥ä¸‹ä½çº§é”™è¯¯**ï¼š

```python
# âŒ ç¦æ­¢1: é‡å¤å®šä¹‰
new_features['price'] = ...  # ç¬¬ä¸€æ¬¡
# ... 100è¡Œä»£ç å ...
new_features['price'] = ...  # âŒ é‡å¤å®šä¹‰ï¼

# âŒ ç¦æ­¢2: å˜é‡æœªå®šä¹‰å°±ä½¿ç”¨
result = calculate(data, label)  # âŒ labelæœªå®šä¹‰
label = df['label']  # å®šä¹‰å¤ªæ™šäº†

# âŒ ç¦æ­¢3: é€»è¾‘é”™è¯¯
if accuracy > 0.5:
    logger.info("å‡†ç¡®ç‡ä½äº50%")  # âŒ é€»è¾‘åäº†

# âŒ ç¦æ­¢4: ç¡¬ç¼–ç 
threshold = 0.001  # âŒ åº”è¯¥ç”¨é…ç½®
data = pd.read_csv("C:\\Users\\data.csv")  # âŒ ç»å¯¹è·¯å¾„

# âŒ ç¦æ­¢5: ç¼ºå°‘é”™è¯¯å¤„ç†
result = risky_operation()  # âŒ å¯èƒ½å¤±è´¥ä½†æ²¡æœ‰try-except

# âŒ ç¦æ­¢6: æœªæ¥å‡½æ•°
df['label'] = df['close'].shift(-5)  # âŒ ä½¿ç”¨æœªæ¥æ•°æ®

# âŒ ç¦æ­¢7: æ—¶åŒºé”™è¯¯
now = datetime.now()  # âŒ æ²¡æœ‰æ—¶åŒºä¿¡æ¯

# âŒ ç¦æ­¢8: ç±»å‹é”™è¯¯
def process(data):  # âŒ ç¼ºå°‘ç±»å‹æç¤º
    return data * 2
```

#### 1.2 ä»£ç è´¨é‡æ£€æŸ¥æ¸…å•

**æ¯æ¬¡æäº¤ä»£ç å‰å¿…é¡»æ£€æŸ¥**ï¼š

- [ ] âœ… æ— é‡å¤å®šä¹‰ï¼ˆç‰¹å¾ã€å˜é‡ã€å‡½æ•°ï¼‰
- [ ] âœ… æ— æœªå®šä¹‰å˜é‡ä½¿ç”¨
- [ ] âœ… æ‰€æœ‰å˜é‡å…ˆå®šä¹‰åä½¿ç”¨
- [ ] âœ… ç±»å‹æç¤ºå®Œæ•´
- [ ] âœ… é”™è¯¯å¤„ç†å®Œå–„
- [ ] âœ… æ—¥å¿—è®°å½•å……åˆ†
- [ ] âœ… æ³¨é‡Šæ¸…æ™°å‡†ç¡®
- [ ] âœ… æ— ç¡¬ç¼–ç å¸¸é‡
- [ ] âœ… æ— é­”æ³•æ•°å­—
- [ ] âœ… é€šè¿‡è¯­æ³•æ£€æŸ¥
- [ ] âœ… é€šè¿‡å•å…ƒæµ‹è¯•
- [ ] âœ… ä»£ç æ ¼å¼è§„èŒƒ

---

### 2. ç‰¹å¾å·¥ç¨‹ä¸“ä¸šè§„èŒƒ

#### 2.1 ç‰¹å¾å®šä¹‰è§„èŒƒ

**å¼ºåˆ¶è§„åˆ™**ï¼š

```python
# âœ… è§„åˆ™1: ç‰¹å¾åç§°å”¯ä¸€æ€§æ£€æŸ¥
def create_features(self, df: pd.DataFrame) -> pd.DataFrame:
    """åˆ›å»ºç‰¹å¾"""
    # ... ç‰¹å¾è®¡ç®— ...
    
    # ğŸ”‘ å¼ºåˆ¶æ£€æŸ¥é‡å¤
    duplicates = df.columns[df.columns.duplicated()].tolist()
    if duplicates:
        raise ValueError(f"âŒ é‡å¤ç‰¹å¾: {duplicates}")
    
    return df

# âœ… è§„åˆ™2: æ·»åŠ ç‰¹å¾å‰æ£€æŸ¥æ˜¯å¦å­˜åœ¨
if 'price_change' not in new_features:
    new_features['price_change'] = df['close'].pct_change()

# âœ… è§„åˆ™3: ä½¿ç”¨æ³¨é‡Šæ ‡è®°ç‰¹å¾æ¥æº
# æ³¨ï¼šupper_shadow åœ¨å¾®è§‚ç»“æ„ç‰¹å¾ä¸­å®šä¹‰ï¼ˆé¿å…é‡å¤ï¼‰

# âœ… è§„åˆ™4: ç‰¹å¾åˆ†ç»„ç®¡ç†
def _add_price_features(self, df):      # ä»·æ ¼ç‰¹å¾ç»„
def _add_volume_features(self, df):     # æˆäº¤é‡ç‰¹å¾ç»„
def _add_technical_indicators(self, df):# æŠ€æœ¯æŒ‡æ ‡ç»„
```

#### 2.2 ç‰¹å¾å‘½åè§„èŒƒ

```python
# âœ… å¥½çš„å‘½å
price_acceleration     # æ¸…æ™°ã€è¯­ä¹‰æ˜ç¡®
rsi_14                # åŒ…å«å‚æ•°
sma_cross_5_20        # æè¿°å…·ä½“å«ä¹‰
volume_spike          # è¡¨è¾¾æ„å›¾

# âŒ å·®çš„å‘½å
pa                    # å¤ªç®€çŸ­
temp                  # ä¸´æ—¶å˜é‡ä¸åº”è¯¥ä¿å­˜
feature_1             # æ— æ„ä¹‰
data                  # å¤ªæ³›åŒ–
```

#### 2.3 ç‰¹å¾éªŒè¯è§„èŒƒ

```python
# âœ… å¿…é¡»éªŒè¯çš„å†…å®¹
def validate_features(self, df: pd.DataFrame):
    """éªŒè¯ç‰¹å¾è´¨é‡"""
    
    # 1. æ£€æŸ¥é‡å¤ç‰¹å¾
    duplicates = df.columns[df.columns.duplicated()].tolist()
    assert len(duplicates) == 0, f"é‡å¤ç‰¹å¾: {duplicates}"
    
    # 2. æ£€æŸ¥NaNæ¯”ä¾‹
    for col in df.columns:
        nan_pct = df[col].isna().sum() / len(df)
        assert nan_pct < 0.2, f"{col} NaNæ¯”ä¾‹è¿‡é«˜: {nan_pct:.1%}"
    
    # 3. æ£€æŸ¥æ•°å€¼èŒƒå›´
    for col in df.select_dtypes(include=[np.number]).columns:
        assert not np.isinf(df[col]).any(), f"{col} å«æœ‰æ— ç©·å¤§"
    
    # 4. æ£€æŸ¥ç‰¹å¾æ•°é‡åˆç†æ€§
    n_samples = len(df)
    n_features = len(df.columns)
    ratio = n_samples / n_features
    assert ratio > 50, f"æ ·æœ¬/ç‰¹å¾æ¯”å¤ªä½: {ratio:.1f}"
```

---

### 3. æœºå™¨å­¦ä¹ ä¸“ä¸šè§„èŒƒ

#### 3.1 è®­ç»ƒæµç¨‹è§„èŒƒ

**ä¸¥æ ¼éµå®ˆçš„é¡ºåº**ï¼š

```python
async def train_model(self, timeframe: str):
    """æ ‡å‡†è®­ç»ƒæµç¨‹"""
    
    # 1ï¸âƒ£ æ•°æ®è·å–
    data = await self._get_training_data(timeframe)
    logger.info(f"âœ… æ•°æ®è·å–: {len(data)}æ¡")
    
    # 2ï¸âƒ£ æ•°æ®éªŒè¯
    self._validate_data(data)
    logger.info(f"âœ… æ•°æ®éªŒè¯é€šè¿‡")
    
    # 3ï¸âƒ£ ç‰¹å¾å·¥ç¨‹
    data = self.feature_engineer.create_features(data)
    logger.info(f"âœ… ç‰¹å¾å·¥ç¨‹: {len(data.columns)}ä¸ªç‰¹å¾")
    
    # 4ï¸âƒ£ åˆ›å»ºæ ‡ç­¾ï¼ˆå¿…é¡»ä¼ å…¥timeframeï¼‰
    data = self._create_labels(data, timeframe=timeframe)
    logger.info(f"âœ… æ ‡ç­¾åˆ›å»ºå®Œæˆ")
    
    # 5ï¸âƒ£ å‡†å¤‡ç‰¹å¾å’Œæ ‡ç­¾
    X, y = self._prepare_features_labels(data, timeframe)
    logger.info(f"âœ… ç‰¹å¾å‡†å¤‡: X={X.shape}, y={y.shape}")
    
    # 6ï¸âƒ£ æ•°æ®åˆ†å‰²ï¼ˆæ—¶é—´åºåˆ—ï¼ï¼‰
    X_train, X_val, y_train, y_val = self._time_series_split(X, y)
    logger.info(f"âœ… æ•°æ®åˆ†å‰²: è®­ç»ƒ{len(X_train)}, éªŒè¯{len(X_val)}")
    
    # 7ï¸âƒ£ ç‰¹å¾ç¼©æ”¾
    X_train_scaled = self._scale_features(X_train, timeframe, fit=True)
    X_val_scaled = self._scale_features(X_val, timeframe, fit=False)
    logger.info(f"âœ… ç‰¹å¾ç¼©æ”¾å®Œæˆ")
    
    # 8ï¸âƒ£ æ¨¡å‹è®­ç»ƒ
    model = self._train_lightgbm(X_train_scaled, y_train, timeframe)
    logger.info(f"âœ… æ¨¡å‹è®­ç»ƒå®Œæˆ")
    
    # 9ï¸âƒ£ æ¨¡å‹è¯„ä¼°
    metrics = self._evaluate_model(model, X_val_scaled, y_val)
    logger.info(f"âœ… æ¨¡å‹è¯„ä¼°: å‡†ç¡®ç‡={metrics['accuracy']:.4f}")
    
    # ğŸ”Ÿ ä¿å­˜æ¨¡å‹
    self._save_model(model, timeframe)
    logger.info(f"âœ… æ¨¡å‹ä¿å­˜å®Œæˆ")
    
    return model, metrics
```

#### 3.2 æ•°æ®éªŒè¯è§„èŒƒ

```python
def _validate_data(self, df: pd.DataFrame):
    """æ•°æ®è´¨é‡æ£€æŸ¥ï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰"""
    
    # 1. åŸºç¡€æ£€æŸ¥
    assert len(df) > 0, "æ•°æ®ä¸ºç©º"
    assert not df.empty, "DataFrameä¸ºç©º"
    
    # 2. å¿…éœ€åˆ—æ£€æŸ¥
    required_cols = ['open', 'high', 'low', 'close', 'volume']
    missing = set(required_cols) - set(df.columns)
    assert len(missing) == 0, f"ç¼ºå°‘åˆ—: {missing}"
    
    # 3. æ•°æ®ç±»å‹æ£€æŸ¥
    for col in required_cols:
        assert pd.api.types.is_numeric_dtype(df[col]), f"{col}ä¸æ˜¯æ•°å€¼ç±»å‹"
    
    # 4. æ•°æ®èŒƒå›´æ£€æŸ¥
    assert (df['high'] >= df['low']).all(), "å­˜åœ¨high < low"
    assert (df['high'] >= df['close']).all(), "å­˜åœ¨high < close"
    assert (df['low'] <= df['close']).all(), "å­˜åœ¨low > close"
    assert (df['volume'] >= 0).all(), "å­˜åœ¨è´Ÿæˆäº¤é‡"
    
    # 5. æ—¶é—´æ’åºæ£€æŸ¥
    if 'timestamp' in df.columns:
        assert df['timestamp'].is_monotonic_increasing, "æ—¶é—´åºåˆ—æœªæ’åº"
    
    # 6. é‡å¤æ•°æ®æ£€æŸ¥
    if 'timestamp' in df.columns:
        duplicates = df['timestamp'].duplicated().sum()
        assert duplicates == 0, f"å­˜åœ¨{duplicates}ä¸ªé‡å¤æ—¶é—´æˆ³"
```

#### 3.3 æ ‡ç­¾åˆ›å»ºè§„èŒƒ

```python
def _create_labels(self, df: pd.DataFrame, timeframe: str) -> pd.DataFrame:
    """åˆ›å»ºæ ‡ç­¾ï¼ˆä¸¥æ ¼è§„èŒƒï¼‰"""
    
    # âŒ ç¦æ­¢ï¼šä½¿ç”¨æœªæ¥å¤šä¸ªKçº¿
    # df['label'] = df['close'].shift(-5)  # âŒ çœ‹æœªæ¥5æ ¹
    
    # âœ… æ­£ç¡®ï¼šåªçœ‹ä¸‹ä¸€æ ¹Kçº¿
    df['next_return'] = df['close'].shift(-1) / df['close'] - 1
    
    # âœ… ä½¿ç”¨å·®å¼‚åŒ–é˜ˆå€¼é…ç½®
    threshold_config = {
        '15m': {'up': 0.001, 'down': -0.001},
        '2h': {'up': 0.0035, 'down': -0.0035},
        '4h': {'up': 0.005, 'down': -0.005}
    }
    
    threshold = threshold_config[timeframe]
    
    # âœ… ä¸‰åˆ†ç±»æ ‡ç­¾
    conditions = [
        df['next_return'] <= threshold['down'],  # SHORT
        df['next_return'] > threshold['up']      # LONG
    ]
    choices = [0, 2]
    df['label'] = np.select(conditions, choices, default=1)  # HOLD
    
    # âœ… æ ‡ç­¾åˆ†å¸ƒéªŒè¯
    label_counts = df['label'].value_counts()
    for label in [0, 1, 2]:
        pct = label_counts.get(label, 0) / len(df) * 100
        logger.info(f"  æ ‡ç­¾{label}: {pct:.1f}%")
        
        # æ£€æŸ¥æ ‡ç­¾åˆ†å¸ƒæ˜¯å¦åˆç†
        if label == 1:  # HOLD
            assert 20 < pct < 50, f"HOLDæ¯”ä¾‹å¼‚å¸¸: {pct:.1f}%"
    
    return df
```

---

### 4. é”™è¯¯é¢„é˜²æªæ–½

#### 4.1 è‡ªåŠ¨æ£€æµ‹æœºåˆ¶

**å¿…é¡»å®æ–½çš„æ£€æµ‹**ï¼š

```python
# 1. é‡å¤ç‰¹å¾æ£€æµ‹
def check_duplicate_features(df: pd.DataFrame):
    """æ£€æµ‹é‡å¤ç‰¹å¾ï¼ˆæ¯æ¬¡ç‰¹å¾å·¥ç¨‹åè°ƒç”¨ï¼‰"""
    duplicates = df.columns[df.columns.duplicated()].tolist()
    if duplicates:
        raise ValueError(f"âŒ å‘ç°é‡å¤ç‰¹å¾: {duplicates}")

# 2. å˜é‡å®šä¹‰æ£€æµ‹
def check_variable_defined(var_name: str, local_vars: dict):
    """æ£€æŸ¥å˜é‡æ˜¯å¦å·²å®šä¹‰"""
    if var_name not in local_vars:
        raise NameError(f"âŒ å˜é‡æœªå®šä¹‰: {var_name}")

# 3. æ•°æ®ç±»å‹æ£€æµ‹
def check_data_types(df: pd.DataFrame, expected_types: dict):
    """æ£€æŸ¥æ•°æ®ç±»å‹"""
    for col, expected_type in expected_types.items():
        if col not in df.columns:
            raise ValueError(f"âŒ åˆ—ä¸å­˜åœ¨: {col}")
        actual_type = df[col].dtype
        if not pd.api.types.is_dtype_equal(actual_type, expected_type):
            raise TypeError(f"âŒ {col}ç±»å‹é”™è¯¯: æœŸæœ›{expected_type}, å®é™…{actual_type}")
```

#### 4.2 ä»£ç å®¡æŸ¥æ¸…å•

**æ¯æ¬¡æäº¤å‰å¿…é¡»æ£€æŸ¥**ï¼š

```markdown
## ä»£ç å®¡æŸ¥æ¸…å•

### åŸºç¡€æ£€æŸ¥
- [ ] æ— è¯­æ³•é”™è¯¯
- [ ] æ— æ‹¼å†™é”™è¯¯
- [ ] æ— æœªä½¿ç”¨çš„å¯¼å…¥
- [ ] æ— æœªä½¿ç”¨çš„å˜é‡
- [ ] æ— æ³¨é‡Šæ‰çš„ä»£ç ï¼ˆåº”åˆ é™¤ï¼‰

### é€»è¾‘æ£€æŸ¥
- [ ] å˜é‡å…ˆå®šä¹‰åä½¿ç”¨
- [ ] å¾ªç¯é€»è¾‘æ­£ç¡®
- [ ] æ¡ä»¶åˆ¤æ–­æ­£ç¡®
- [ ] è¿”å›å€¼ç±»å‹æ­£ç¡®
- [ ] è¾¹ç•Œæ¡ä»¶å¤„ç†

### æ•°æ®æ£€æŸ¥
- [ ] æ— æœªæ¥å‡½æ•°
- [ ] æ—¶é—´åºåˆ—æ­£ç¡®æ’åº
- [ ] æ ‡ç­¾åˆ›å»ºæ­£ç¡®
- [ ] ç‰¹å¾æ— é‡å¤
- [ ] æ•°æ®ç±»å‹æ­£ç¡®

### æ€§èƒ½æ£€æŸ¥
- [ ] æ— æ€§èƒ½ç“¶é¢ˆ
- [ ] æ— å†…å­˜æ³„æ¼
- [ ] æ— æ— é™å¾ªç¯
- [ ] åˆç†ä½¿ç”¨ç¼“å­˜
- [ ] å¼‚æ­¥æ“ä½œæ­£ç¡®

### å®‰å…¨æ£€æŸ¥
- [ ] æ— SQLæ³¨å…¥é£é™©
- [ ] æ— å¯†é’¥ç¡¬ç¼–ç 
- [ ] è¾“å…¥éªŒè¯å®Œæ•´
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] æ—¥å¿—ä¸å«æ•æ„Ÿä¿¡æ¯
```

#### 4.3 å•å…ƒæµ‹è¯•è§„èŒƒ

**å…³é”®åŠŸèƒ½å¿…é¡»æµ‹è¯•**ï¼š

```python
import pytest
import pandas as pd
import numpy as np

# âœ… æµ‹è¯•1: ç‰¹å¾æ— é‡å¤
def test_no_duplicate_features():
    """æµ‹è¯•ç‰¹å¾å·¥ç¨‹æ— é‡å¤"""
    from app.services.feature_engineering import FeatureEngineer
    
    fe = FeatureEngineer()
    data = create_test_data()
    result = fe.create_features(data)
    
    # æ£€æŸ¥é‡å¤
    duplicates = result.columns[result.columns.duplicated()].tolist()
    assert len(duplicates) == 0, f"å‘ç°é‡å¤ç‰¹å¾: {duplicates}"

# âœ… æµ‹è¯•2: æ ‡ç­¾åˆ†å¸ƒåˆç†
def test_label_distribution():
    """æµ‹è¯•æ ‡ç­¾åˆ†å¸ƒåˆç†æ€§"""
    from app.services.ml_service import MLService
    
    ml = MLService()
    data = create_test_data()
    data = ml._create_labels(data, timeframe='15m')
    
    # æ£€æŸ¥æ ‡ç­¾åˆ†å¸ƒ
    counts = data['label'].value_counts()
    for label in [0, 1, 2]:
        pct = counts[label] / len(data) * 100
        assert 20 < pct < 50, f"æ ‡ç­¾{label}åˆ†å¸ƒå¼‚å¸¸: {pct:.1f}%"

# âœ… æµ‹è¯•3: æ— æœªæ¥å‡½æ•°
def test_no_future_function():
    """æµ‹è¯•æ— æœªæ¥æ•°æ®æ³„éœ²"""
    from app.services.ml_service import MLService
    
    ml = MLService()
    data = create_test_data()
    
    # æ£€æŸ¥shiftæ–¹å‘
    assert 'next_return' in data.columns
    # next_returnåº”è¯¥åªä½¿ç”¨shift(-1)
    # ä¸åº”è¯¥ä½¿ç”¨shift(-n) where n > 1

# âœ… æµ‹è¯•4: æ—¶é—´åºåˆ—åˆ†å‰²
def test_time_series_split():
    """æµ‹è¯•æ—¶é—´åºåˆ—åˆ†å‰²æ­£ç¡®æ€§"""
    from app.services.ml_service import MLService
    
    ml = MLService()
    X, y = create_test_features_labels()
    
    X_train, X_val, y_train, y_val = ml._time_series_split(X, y)
    
    # è®­ç»ƒé›†åº”è¯¥åœ¨éªŒè¯é›†ä¹‹å‰
    assert len(X_train) > 0
    assert len(X_val) > 0
    # ä¸åº”è¯¥ä½¿ç”¨shuffle=True
```

---

### 5. ä»£ç æäº¤è§„èŒƒ

#### 5.1 æäº¤å‰æ£€æŸ¥æµç¨‹

```bash
# 1. ä»£ç æ ¼å¼åŒ–
black backend/app/services/
isort backend/app/services/

# 2. è¯­æ³•æ£€æŸ¥
pylint backend/app/services/ml_service.py
mypy backend/app/services/ml_service.py

# 3. è¿è¡Œæµ‹è¯•
pytest tests/ -v

# 4. æ£€æŸ¥è¦†ç›–ç‡
pytest tests/ --cov=app --cov-report=html

# 5. æ‰‹åŠ¨å®¡æŸ¥æ¸…å•
# - æ— é‡å¤ç‰¹å¾
# - æ— æœªå®šä¹‰å˜é‡
# - æ— ä½çº§é”™è¯¯
# - æ—¥å¿—å……åˆ†
# - æ³¨é‡Šæ¸…æ™°
```

#### 5.2 æäº¤ä¿¡æ¯è§„èŒƒ

```bash
# âœ… å¥½çš„æäº¤ä¿¡æ¯
git commit -m "fix: ä¿®å¤upper_shadowé‡å¤å®šä¹‰é”™è¯¯

- åˆ é™¤ä»·æ ¼ç‰¹å¾ä¸­çš„é‡å¤å®šä¹‰
- ä¿ç•™å¾®è§‚ç»“æ„ç‰¹å¾ä¸­çš„ç‰ˆæœ¬ï¼ˆæ›´å¥½çš„å½’ä¸€åŒ–ï¼‰
- æ·»åŠ æ³¨é‡Šé˜²æ­¢æœªæ¥é‡å¤
- é€šè¿‡å•å…ƒæµ‹è¯•éªŒè¯

Issue: #123
"

# âŒ å·®çš„æäº¤ä¿¡æ¯
git commit -m "ä¿®å¤bug"
git commit -m "æ›´æ–°"
git commit -m "ä¸´æ—¶æäº¤"
```

---

### 6. æ€§èƒ½ä¼˜åŒ–è§„èŒƒ

#### 6.1 ä¼˜åŒ–å‰å¿…é¡»æµ‹è¯•

```python
import time
import cProfile
import memory_profiler

# âœ… æ€§èƒ½æµ‹è¯•æ¨¡æ¿
def benchmark_feature_engineering():
    """åŸºå‡†æµ‹è¯•ç‰¹å¾å·¥ç¨‹æ€§èƒ½"""
    from app.services.feature_engineering import FeatureEngineer
    
    fe = FeatureEngineer()
    data = load_large_dataset()  # 10000è¡Œ
    
    # æµ‹è¯•å‰
    start_time = time.time()
    result = fe.create_features(data)
    end_time = time.time()
    
    duration = end_time - start_time
    
    print(f"ç‰¹å¾å·¥ç¨‹è€—æ—¶: {duration:.2f}ç§’")
    print(f"å¤„ç†é€Ÿåº¦: {len(data)/duration:.0f}è¡Œ/ç§’")
    print(f"ç‰¹å¾æ•°é‡: {len(result.columns)}")
    
    return duration

# âœ… å†…å­˜æµ‹è¯•
@memory_profiler.profile
def test_memory_usage():
    """æµ‹è¯•å†…å­˜ä½¿ç”¨"""
    from app.services.ml_service import MLService
    
    ml = MLService()
    # ... æµ‹è¯•ä»£ç  ...
```

#### 6.2 ä¼˜åŒ–åå¿…é¡»å¯¹æ¯”

```python
# âœ… A/Bæµ‹è¯•å¯¹æ¯”
def compare_performance():
    """å¯¹æ¯”ä¼˜åŒ–å‰åæ€§èƒ½"""
    
    # ä¼˜åŒ–å‰
    time_before = benchmark_old_method()
    
    # ä¼˜åŒ–å
    time_after = benchmark_new_method()
    
    # è®¡ç®—æ”¹è¿›
    improvement = (time_before - time_after) / time_before * 100
    
    print(f"ä¼˜åŒ–å‰: {time_before:.2f}ç§’")
    print(f"ä¼˜åŒ–å: {time_after:.2f}ç§’")
    print(f"æ€§èƒ½æå‡: {improvement:.1f}%")
    
    # å¿…é¡»æœ‰æå‡
    assert improvement > 0, "ä¼˜åŒ–åæ€§èƒ½åè€Œä¸‹é™"
```

---

### 7. æ–‡æ¡£è§„èŒƒ

#### 7.1 ä»£ç æ³¨é‡Šè§„èŒƒ

```python
# âœ… å¥½çš„æ³¨é‡Š
def _select_features_intelligent(
    self, 
    X: pd.DataFrame, 
    y: pd.Series, 
    timeframe: str
) -> list:
    """
    æ™ºèƒ½ç‰¹å¾é€‰æ‹©ï¼ˆä¸¤é˜¶æ®µ + åŠ¨æ€é¢„ç®—ï¼‰
    
    é˜¶æ®µ1: Filterè¿‡æ»¤ä½é‡è¦æ€§ç‰¹å¾ï¼ˆåŸºäºLightGBMé‡è¦æ€§ï¼‰
    é˜¶æ®µ2: åµŒå…¥å¼é€‰æ‹©ï¼ˆSelectFromModel + åŠ¨æ€é¢„ç®—ï¼‰
    
    Args:
        X: ç‰¹å¾DataFrame
        y: æ ‡ç­¾Series
        timeframe: æ—¶é—´æ¡†æ¶ï¼ˆ'15m', '2h', '4h'ï¼‰
    
    Returns:
        é€‰ä¸­çš„ç‰¹å¾åˆ—è¡¨
    
    ä¼˜åŒ–ç›®æ ‡:
        - æå‡å‡†ç¡®ç‡5-10%
        - æ ·æœ¬/ç‰¹å¾æ¯”>100:1
        - é˜²æ­¢è¿‡æ‹Ÿåˆ
    
    Example:
        >>> features = self._select_features_intelligent(X, y, '15m')
        >>> print(len(features))  # 150
    """
    # ... å®ç°

# âŒ å·®çš„æ³¨é‡Š
def select(X, y, t):
    """é€‰æ‹©ç‰¹å¾"""  # å¤ªç®€çŸ­
    # ... å®ç°
```

#### 7.2 ä¿®å¤æ–‡æ¡£è§„èŒƒ

**æ¯æ¬¡ä¿®å¤Bugå¿…é¡»æ–‡æ¡£åŒ–**ï¼š

```markdown
# Bugä¿®å¤æŠ¥å‘Šæ¨¡æ¿

## é—®é¢˜æè¿°
- é”™è¯¯ä¿¡æ¯: XXX
- å½±å“èŒƒå›´: XXX
- ä¸¥é‡æ€§: CRITICAL/HIGH/MEDIUM/LOW

## æ ¹æœ¬åŸå› 
- ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé”™è¯¯ï¼Ÿ
- ä»€ä¹ˆæ—¶å€™å¼•å…¥çš„ï¼Ÿ
- ä¸ºä»€ä¹ˆä¹‹å‰æ²¡å‘ç°ï¼Ÿ

## ä¿®å¤æ–¹æ¡ˆ
- ä¿®æ”¹äº†å“ªäº›æ–‡ä»¶ï¼Ÿ
- ä¿®æ”¹äº†å“ªäº›ä»£ç ï¼Ÿ
- ä¸ºä»€ä¹ˆè¿™æ ·ä¿®å¤ï¼Ÿ

## éªŒè¯æ–¹æ³•
- å¦‚ä½•éªŒè¯ä¿®å¤æˆåŠŸï¼Ÿ
- æµ‹è¯•ç”¨ä¾‹ï¼Ÿ
- æ€§èƒ½å½±å“ï¼Ÿ

## é¢„é˜²æªæ–½
- å¦‚ä½•é¿å…ç±»ä¼¼é”™è¯¯ï¼Ÿ
- éœ€è¦æ·»åŠ ä»€ä¹ˆæ£€æµ‹æœºåˆ¶ï¼Ÿ
- éœ€è¦æ›´æ–°ä»€ä¹ˆæ–‡æ¡£ï¼Ÿ
```

---

### 8. ç¦æ­¢çš„æ“ä½œ

**ä¸¥æ ¼ç¦æ­¢ä»¥ä¸‹æ“ä½œ**ï¼š

```python
# âŒ ç¦æ­¢1: ä¿®æ”¹åä¸æµ‹è¯•
# ä¿®æ”¹ä»£ç  â†’ ç›´æ¥æäº¤ âŒ
# âœ… æ­£ç¡®: ä¿®æ”¹ä»£ç  â†’ æµ‹è¯• â†’ æäº¤

# âŒ ç¦æ­¢2: è·³è¿‡ä»£ç å®¡æŸ¥
git push origin main  # âŒ ç›´æ¥æ¨é€åˆ°ä¸»åˆ†æ”¯

# âŒ ç¦æ­¢3: åˆ é™¤æµ‹è¯•
# ä¸ºäº†è®©ä»£ç é€šè¿‡è€Œåˆ é™¤æµ‹è¯• âŒ

# âŒ ç¦æ­¢4: å¿½ç•¥è­¦å‘Š
# pylint: disable=all  # âŒ ç¦ç”¨æ‰€æœ‰è­¦å‘Š

# âŒ ç¦æ­¢5: ä¸´æ—¶ä¿®å¤ä¸è®°å½•
# ä¸´æ—¶è§£å†³é—®é¢˜ï¼Œä¸è®°å½•ä¸æ–‡æ¡£åŒ– âŒ

# âŒ ç¦æ­¢6: å¤åˆ¶ç²˜è´´ä¸é‡æ„
# å¤åˆ¶ç›¸åŒä»£ç åˆ°å¤šä¸ªåœ°æ–¹ âŒ

# âŒ ç¦æ­¢7: ä¿®æ”¹åä¸æ›´æ–°æ–‡æ¡£
# ä¿®æ”¹ä»£ç ä½†ä¸æ›´æ–°æ³¨é‡Šå’Œæ–‡æ¡£ âŒ

# âŒ ç¦æ­¢8: ä½¿ç”¨å…¨å±€å˜é‡
global_data = []  # âŒ é¿å…ä½¿ç”¨å…¨å±€å¯å˜å˜é‡

# âŒ ç¦æ­¢9: æ•è·æ‰€æœ‰å¼‚å¸¸
try:
    risky_operation()
except:  # âŒ ä¸æŒ‡å®šå¼‚å¸¸ç±»å‹
    pass  # âŒ å¿½ç•¥å¼‚å¸¸

# âŒ ç¦æ­¢10: ç¡¬ç¼–ç é…ç½®
API_KEY = "abc123"  # âŒ åº”è¯¥ç”¨ç¯å¢ƒå˜é‡
```

---

### 9. ä¸“ä¸šå·¥ç¨‹å¸ˆæ£€æŸ¥æ¸…å•

**æ¯å¤©å¼€å‘ç»“æŸå‰æ£€æŸ¥**ï¼š

```markdown
## ä»Šæ—¥ä»£ç è´¨é‡æ£€æŸ¥

### ä»£ç è´¨é‡ âœ…
- [ ] æ— é‡å¤å®šä¹‰
- [ ] æ— æœªå®šä¹‰å˜é‡
- [ ] ç±»å‹æç¤ºå®Œæ•´
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] æ—¥å¿—è®°å½•å……åˆ†
- [ ] æ³¨é‡Šæ¸…æ™°å‡†ç¡®

### æµ‹è¯•è¦†ç›– âœ…
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] è¾¹ç•Œæ¡ä»¶æµ‹è¯•

### æ–‡æ¡£æ›´æ–° âœ…
- [ ] ä»£ç æ³¨é‡Šæ›´æ–°
- [ ] APIæ–‡æ¡£æ›´æ–°
- [ ] READMEæ›´æ–°
- [ ] ä¿®å¤æ–‡æ¡£è®°å½•

### æ€§èƒ½ä¼˜åŒ– âœ…
- [ ] æ— æ€§èƒ½é€€åŒ–
- [ ] æ— å†…å­˜æ³„æ¼
- [ ] å“åº”æ—¶é—´è¾¾æ ‡
- [ ] èµ„æºä½¿ç”¨åˆç†

### å®‰å…¨æ£€æŸ¥ âœ…
- [ ] æ— å¯†é’¥æ³„éœ²
- [ ] è¾“å…¥éªŒè¯å®Œæ•´
- [ ] é”™è¯¯ä¿¡æ¯å®‰å…¨
- [ ] æ—¥å¿—è„±æ•å¤„ç†
```

---

### 10. æŒç»­æ”¹è¿›

#### 10.1 å®šæœŸå®¡æŸ¥

```markdown
## æ¯å‘¨ä»£ç å®¡æŸ¥ï¼ˆå‘¨äº”ä¸‹åˆï¼‰

1. ä»£ç è´¨é‡å›é¡¾
   - æœ¬å‘¨å‘ç°çš„Bug
   - ä½çº§é”™è¯¯ç»Ÿè®¡
   - ä»£ç å¤æ‚åº¦åˆ†æ

2. æ€§èƒ½æŒ‡æ ‡å›é¡¾
   - å‡†ç¡®ç‡è¶‹åŠ¿
   - ç³»ç»Ÿå»¶è¿Ÿ
   - èµ„æºä½¿ç”¨

3. æ”¹è¿›æªæ–½
   - éœ€è¦æ·»åŠ çš„æ£€æµ‹
   - éœ€è¦ä¼˜åŒ–çš„ä»£ç 
   - éœ€è¦æ›´æ–°çš„æ–‡æ¡£

4. ä¸‹å‘¨è®¡åˆ’
   - é‡ç‚¹ä¼˜åŒ–é¡¹
   - æŠ€æœ¯å€ºåŠ¡æ¸…ç†
   - æ–°åŠŸèƒ½å¼€å‘
```

#### 10.2 çŸ¥è¯†ç§¯ç´¯

```markdown
## é—®é¢˜è®°å½•ä¸æ€»ç»“

### Bugè®°å½•
- æ—¥æœŸ: 2025-10-17
- é—®é¢˜: é‡å¤ç‰¹å¾å®šä¹‰
- åŸå› : æœªæ£€æŸ¥ç°æœ‰ç‰¹å¾
- ä¿®å¤: åˆ é™¤é‡å¤ + æ·»åŠ æ£€æµ‹
- é¢„é˜²: æ·»åŠ è‡ªåŠ¨æ£€æµ‹æœºåˆ¶

### ç»éªŒæ€»ç»“
- æ•™è®­: ä¸è¦ç›²ç›®æ·»åŠ ç‰¹å¾
- æ”¹è¿›: å…ˆæ£€æŸ¥åæ·»åŠ 
- å·¥å…·: ä½¿ç”¨è‡ªåŠ¨æ£€æµ‹
- æ–‡æ¡£: æ›´æ–°è§„åˆ™æ–‡ä»¶
```

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- **ä¼˜åŒ–è·¯çº¿å›¾**ï¼š`OPTIMIZATION_ROADMAP.md`ï¼ˆå®Œæ•´ä¼˜åŒ–è®¡åˆ’ï¼‰
- **åç«¯è§„åˆ™**ï¼š`.cursor/rules/backend.mdc`
- **å‰ç«¯è§„åˆ™**ï¼š`.cursor/rules/frontend.mdc`
- **éƒ¨ç½²æ–‡æ¡£**ï¼š`DEPLOYMENT.md`
- **é¡¹ç›®æ€»ç»“**ï¼š`PROJECT_SUMMARY.md`
- **Bugä¿®å¤è®°å½•**ï¼š`docs/CRITICAL_*.md`

---

**ç‰ˆæœ¬**: v7.0  
**æ›´æ–°æ—¥æœŸ**: 2025-10-17  
**æ›´æ–°å†…å®¹**: 
- ğŸ†• **æ·»åŠ ä¸“ä¸šé‡åŒ–å·¥ç¨‹å¸ˆä»£ç è§„èŒƒç« èŠ‚**
- ä¸¥æ ¼å®šä¹‰é›¶å®¹å¿é”™è¯¯æ¸…å•
- å®Œå–„ç‰¹å¾å·¥ç¨‹ä¸“ä¸šè§„èŒƒ
- æ·»åŠ é”™è¯¯é¢„é˜²æªæ–½
- å»ºç«‹ä»£ç å®¡æŸ¥æ¸…å•
- åˆ¶å®šå•å…ƒæµ‹è¯•è§„èŒƒ
- è§„èŒƒä»£ç æäº¤æµç¨‹
- å®šä¹‰æ€§èƒ½ä¼˜åŒ–æ ‡å‡†
- å®Œå–„æ–‡æ¡£è§„èŒƒ
- æ˜ç¡®ç¦æ­¢æ“ä½œæ¸…å•
- å»ºç«‹æŒç»­æ”¹è¿›æœºåˆ¶
**é€‚ç”¨èŒƒå›´**: å…¨é¡¹ç›®ï¼ˆå‰ç«¯+åç«¯ï¼‰
