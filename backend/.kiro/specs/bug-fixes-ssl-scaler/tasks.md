# 实现计划 - SSL连接和梯度缩放器问题修复

## 任务列表

- [x] 1. 配置层增强


  - 在`app/core/config.py`中添加WebSocket重连配置参数
  - 在`app/core/config.py`中添加GradScaler配置参数
  - 验证配置参数的合理性（范围检查）
  - _需求: 4.1, 4.2, 4.3, 4.4_





- [ ] 2. WebSocket指数退避重连策略实现
- [ ] 2.1 创建ExponentialBackoffReconnector类
  - 在`app/exchange/binance_client.py`中实现指数退避算法
  - 实现重连历史记录管理（最近10次）


  - 实现重连统计信息收集
  - _需求: 1.1, 3.1, 3.3_

- [x] 2.2 集成重连策略到BinanceWebSocketClient

  - 修改`_reconnect()`方法使用指数退避策略
  - 替换固定延迟为动态计算延迟
  - 添加重连次数限制检查
  - _需求: 1.1, 1.4_

- [ ] 2.3 实现重连错误分类和诊断
  - 创建错误分类函数`classify_error()`
  - 根据错误类型记录不同的诊断信息
  - 实现SSL错误的详细堆栈记录
  - _需求: 1.3, 3.1, 3.2_





- [ ]* 2.4 编写重连策略单元测试
  - 测试延迟计算算法
  - 测试最大重试次数限制
  - 测试重置功能
  - 测试重连成功和失败场景


  - _需求: 1.1, 1.4_

- [ ] 3. WebSocket心跳保活机制实现
- [ ] 3.1 创建WebSocketHeartbeat类
  - 实现心跳循环任务
  - 实现ping发送逻辑（30秒间隔）
  - 实现pong超时检测（10秒）
  - 实现连接存活状态检查
  - _需求: 1.2_





- [ ] 3.2 集成心跳机制到BinanceWebSocketClient
  - 在`start_websocket()`中启动心跳任务
  - 在`_on_pong()`中更新最后pong时间
  - 在`stop_websocket()`中停止心跳任务

  - _需求: 1.2_

- [ ]* 3.3 编写心跳机制单元测试
  - 测试ping发送间隔
  - 测试pong超时检测
  - 测试连接存活判断
  - _需求: 1.2_

- [ ] 4. SSL配置优化
- [ ] 4.1 优化SSL上下文配置
  - 在`BinanceWebSocketClient.__init__()`中创建SSL上下文




  - 禁用SSLv2和SSLv3旧协议
  - 配置安全密码套件
  - 设置SSL握手超时为30秒
  - _需求: 1.5_

- [ ] 4.2 更新WebSocket连接参数
  - 添加`sslopt`配置到ws_kwargs
  - 配置整体超时参数
  - 启用内置ping/pong机制
  - _需求: 1.2, 1.5_

- [ ]* 4.3 编写SSL配置测试
  - 测试SSL上下文创建
  - 测试超时配置
  - 测试协议版本限制
  - _需求: 1.5_


- [x] 5. 梯度缩放器动态配置实现

- [x] 5.1 创建DynamicGradScalerConfig类

  - 在`app/model/hyperparameter_optimizer.py`中实现动态配置类
  - 实现`calculate_init_scale()`方法（根据模型参数量）
  - 实现`create_scaler()`方法（创建配置好的GradScaler）
  - 配置保守增长参数（growth_factor=1.2, growth_interval=2000）
  - _需求: 2.1, 2.2_

- [x] 5.2 集成动态配置到超参数优化器


  - 修改`objective()`方法中的GradScaler创建逻辑
  - 计算模型参数量并选择合适的初始scale
  - 使用新的growth_factor和growth_interval参数
  - 记录配置信息到日志
  - _需求: 2.1, 2.2, 2.5_

- [ ]* 5.3 编写动态配置单元测试
  - 测试不同模型规模的初始scale计算
  - 测试GradScaler创建
  - 测试配置参数应用
  - _需求: 2.1_

- [x] 6. GradScaler监控器实现


- [x] 6.1 创建GradScalerMonitor类

  - 在`app/model/hyperparameter_optimizer.py`中实现监控类
  - 实现`record_scale()`方法（记录scale历史）
  - 实现`check_overflow()`方法（检测连续溢出）
  - 实现`reset_scale()`方法（自动重置scale）
  - 实现`get_statistics()`方法（获取统计信息）
  - _需求: 2.3, 2.4, 2.5_

- [x] 6.2 集成监控器到训练循环


  - 在每个batch后调用`record_scale()`
  - 在检测到溢出时调用`check_overflow()`
  - 在scale超过阈值时记录WARNING日志
  - 在连续溢出时触发自动重置
  - 在每个epoch结束时记录scale统计信息
  - _需求: 2.3, 2.4, 2.5_

- [x] 6.3 实现scale异常处理逻辑

  - 检测scale值超过100000阈值
  - 检测连续5次梯度溢出
  - 检测连续3个epoch的scale异常
  - 触发自动重置并记录详细诊断信息
  - _需求: 2.3, 2.4_

- [ ]* 6.4 编写监控器单元测试
  - 测试scale阈值检测
  - 测试溢出检测逻辑
  - 测试自动重置功能
  - 测试统计信息收集
  - _需求: 2.3, 2.4_




- [ ] 7. 错误诊断和日志增强
- [ ] 7.1 增强WebSocket错误日志
  - 在`_on_error()`中添加完整错误堆栈记录
  - 记录连接状态、重连次数和时间戳

  - 实现错误模式分析（如固定时间断连）
  - _需求: 3.1, 3.3_

- [ ] 7.2 增强训练诊断日志
  - 在检测到scale异常时记录详细信息
  - 记录当前epoch、batch、scale值、梯度范数

  - 记录模型输出统计信息
  - 在训练开始前验证输入数据（无NaN/Inf）
  - _需求: 2.5, 3.2, 3.4_

- [ ] 7.3 实现监控指标收集
  - 收集WebSocket连接指标（运行时间、重连次数、成功率等）
  - 收集训练指标（scale值、溢出率、重置次数等）
  - 实现`get_connection_stats()`方法
  - 实现`get_training_stats()`方法
  - _需求: 3.2, 3.5_





- [ ]* 7.4 编写诊断日志测试
  - 测试错误日志格式
  - 测试诊断信息完整性
  - 测试指标收集准确性
  - _需求: 3.1, 3.2_


- [ ] 8. 配置验证和向后兼容性
- [ ] 8.1 实现配置参数验证
  - 验证重连参数范围（延迟>0，重试次数>0）
  - 验证GradScaler参数范围（growth_factor>1，max_scale>0）
  - 在配置加载时执行验证
  - 对不合法配置抛出清晰的错误信息
  - _需求: 4.4, 5.4_

- [ ] 8.2 确保API向后兼容
  - 保持所有公共方法签名不变
  - 为新配置参数提供默认值
  - 确保旧配置文件无需修改即可使用
  - 验证已训练模型可正常加载
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ]* 8.3 编写兼容性测试
  - 测试旧配置文件加载
  - 测试API接口兼容性
  - 测试模型文件兼容性
  - _需求: 5.1, 5.2, 5.3_

- [ ] 9. 集成测试和验证
- [ ] 9.1 WebSocket连接稳定性测试
  - 测试正常连接和断开
  - 模拟网络中断并验证自动重连
  - 验证订阅恢复功能
  - 验证心跳保活机制
  - _需求: 1.1, 1.2, 1.4_

- [ ] 9.2 模型训练稳定性测试
  - 使用真实数据训练Informer2模型
  - 验证scale值保持在合理范围
  - 验证无NaN/Inf出现
  - 验证自动重置功能正常工作
  - _需求: 2.1, 2.2, 2.3, 2.4_

- [x] 9.3 性能回归测试





  - 验证WebSocket消息处理性能未下降
  - 验证训练速度未明显降低
  - 验证内存使用未显著增加
  - _需求: 5.5_


- [ ]* 9.4 编写端到端测试
  - 测试完整的交易系统流程
  - 验证所有功能正常工作
  - 验证日志输出符合预期
  - _需求: 1.1, 1.2, 2.1, 2.2, 2.3, 2.4_

- [ ] 10. 文档更新
- [ ] 10.1 更新README.md
  - 添加新配置项说明
  - 添加WebSocket重连策略说明
  - 添加GradScaler配置说明
  - _需求: 4.1, 4.2_

- [ ] 10.2 更新代码注释
  - 为新增类和方法添加详细docstring
  - 更新修改过的方法的注释
  - 添加关键算法的说明注释
  - _需求: 5.1, 5.2_

- [ ]* 10.3 创建故障排查文档
  - 记录常见问题和解决方案
  - 添加监控指标说明
  - 添加告警处理流程
  - _需求: 3.1, 3.2, 3.3_
